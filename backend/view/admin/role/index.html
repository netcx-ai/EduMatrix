<!-- 角色列表页 -->
{extend name="common/base"/}
{block name="content"}
<div class="layui-card">
  <div class="layui-card-header">
    <div class="layui-row">
      <div class="layui-col-md6">
        <h3>角色管理</h3>
      </div>
      <div class="layui-col-md6" style="text-align: right;">
        <button class="layui-btn layui-btn-normal" onclick="openAddRole()">
          <i class="layui-icon layui-icon-add-1"></i> 添加角色
        </button>
      </div>
    </div>
  </div>
  <div class="layui-card-body">
    <!-- 搜索区域 -->
    <div class="layui-form layui-form-pane" style="margin-bottom: 15px;">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">搜索关键词</label>
          <div class="layui-input-inline">
            <input type="text" id="searchKeyword" placeholder="角色名称/标识/描述" class="layui-input">
          </div>
        </div>
        <div class="layui-inline">
          <button class="layui-btn" onclick="searchRoles()">
            <i class="layui-icon layui-icon-search"></i> 搜索
          </button>
          <button class="layui-btn layui-btn-primary" onclick="resetSearch()">
            <i class="layui-icon layui-icon-refresh"></i> 重置
          </button>
        </div>
      </div>
    </div>
    
    <!-- 表格区域 -->
    <table id="roleTable" lay-filter="roleTable"></table>
  </div>
</div>

<!-- 操作按钮模板 -->
<script type="text/html" id="roleBar">
  <a class="layui-btn layui-btn-xs" lay-event="edit">
    <i class="layui-icon layui-icon-edit"></i> 编辑
  </a>
  <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="permission">
    <i class="layui-icon layui-icon-set"></i> 权限
  </a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">
    <i class="layui-icon layui-icon-delete"></i> 删除
  </a>
</script>

<!-- 状态模板 -->
<script type="text/html" id="statusTpl">
  {{# if(d.status == 1) { }}
    <span class="layui-badge layui-bg-green">启用</span>
  {{# } else { }}
    <span class="layui-badge layui-bg-gray">禁用</span>
  {{# } }}
</script>
{/block}

{block name="script"}
<script>
layui.use(['table', 'layer', 'form'], function(){
  var table = layui.table;
  var layer = layui.layer;
  var form = layui.form;
  
  // 渲染表格
  table.render({
    elem: '#roleTable',
    url: '/admin/role/index',
    toolbar: true,
    defaultToolbar: ['filter', 'exports', 'print'],
    cols: [[
      {type: 'checkbox', fixed: 'left'},
      {field:'id', title:'ID', width:80, sort: true},
      {field:'name', title:'角色名称'},
      {field:'code', title:'角色标识'},
      {field:'description', title:'描述',width:500},
      {field:'create_time', title:'创建时间', sort: true},
      {field:'update_time', title:'更新时间', sort: true},
      {fixed:'right', title:'操作', toolbar:'#roleBar',width:240}
    ]],
    page: true,
    limit: 20,
    limits: [10, 20, 50, 100],
    height: 'full-220',
    text: {
      none: '暂无相关数据'
    },
    done: function(res, curr, count) {
      console.log('表格渲染完成，共' + count + '条数据');
    }
  });
  
  // 监听工具条
  table.on('tool(roleTable)', function(obj){
    var data = obj.data;
    if(obj.event === 'edit'){
      layer.open({
        type: 2,
        title: '编辑角色',
        area: ['600px', '450px'],
        content: '/admin/role/edit?id=' + data.id,
        shadeClose: true,
        maxmin: true,
        resize: false
      });
    } else if(obj.event === 'permission'){
      layer.open({
        type: 2,
        title: '分配权限 - ' + data.name,
        area: ['800px', '600px'],
        content: '/admin/role/permission?id=' + data.id,
        shadeClose: true,
        maxmin: true,
        resize: false
      });
    } else if(obj.event === 'del'){
      layer.confirm('确定删除角色 <strong>' + data.name + '</strong> 吗？', {
        icon: 3,
        title: '删除确认',
        btn: ['确定', '取消']
      }, function(index){
        $.post('/admin/role/delete', {id: data.id}, function(res){
          if(res.code === 0){
            layer.msg('删除成功', {icon: 1});
            obj.del();
          } else {
            layer.msg(res.msg || '删除失败', {icon: 2});
          }
        });
        layer.close(index);
      });
    }
  });
  
  // 监听排序
  table.on('sort(roleTable)', function(obj){
    table.reload('roleTable', {
      initSort: obj,
      where: {
        sort: obj.field,
        order: obj.type
      }
    });
  });
});

// 搜索角色
function searchRoles() {
  var keyword = $('#searchKeyword').val();
  layui.table.reload('roleTable', {
    where: {
      keyword: keyword
    },
    page: {
      curr: 1
    }
  });
}

// 重置搜索
function resetSearch() {
  $('#searchKeyword').val('');
  layui.table.reload('roleTable', {
    where: {},
    page: {
      curr: 1
    }
  });
}

// 添加角色
function openAddRole(){
  layer.open({
    type: 2,
    title: '添加角色',
    area: ['600px', '450px'],
    content: '/admin/role/add',
    shadeClose: true,
    maxmin: true,
    resize: false
  });
}

// 回车搜索
$(document).on('keypress', '#searchKeyword', function(e) {
  if(e.which == 13) {
    searchRoles();
  }
});
</script>
{/block} 