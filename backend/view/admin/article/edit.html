<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>编辑文章</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <link href="/static/wangeditor/style.css" rel="stylesheet">
    <style>
        body { padding: 10px; background: #f2f2f2; }
        .layui-card { margin-bottom: 0; }
        .layui-card-header { padding: 10px 15px; }
        .layui-card-body { padding: 15px; }
    </style>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-orange">编辑文章</span>
                </div>
                <div class="layui-card-body">
                    <form class="layui-form" lay-filter="articleForm">
                        <input type="hidden" name="id" value="{$article.id}">
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">文章标题</label>
                            <div class="layui-input-block">
                                <input type="text" name="title" value="{$article.title}" placeholder="请输入文章标题" autocomplete="off" class="layui-input" lay-verify="required">
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">文章分类</label>
                            <div class="layui-input-inline">
                                <select name="category_id" lay-verify="required">
                                    <option value="">请选择分类</option>
                                    {volist name="categories" id="category"}
                                    <option value="{$category.id}" {if $article.category_id == $category.id}selected{/if}>{$category.name}</option>
                                    {/volist}
                                </select>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">文章标签</label>
                            <div class="layui-input-block">
                                <div id="tagContainer">
                                    {volist name="tags" id="tag"}
                                    <input type="checkbox" name="tag_ids[]" value="{$tag.id}" title="{$tag.name}" lay-skin="primary" {if in_array($tag.id, $article.tag_ids)}checked{/if}>
                                    {/volist}
                                </div>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">封面图片</label>
                            <div class="layui-input-block">
                                <input type="text" name="cover_image" value="{$article.cover_image}" placeholder="请输入图片URL或上传图片" autocomplete="off" class="layui-input">
                                <button type="button" class="layui-btn layui-btn-sm" id="uploadImage">
                                    <i class="layui-icon layui-icon-upload"></i> 上传图片
                                </button>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">文章摘要</label>
                            <div class="layui-input-block">
                                <textarea name="summary" placeholder="请输入文章摘要" class="layui-textarea" rows="3">{$article.summary}</textarea>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">文章内容</label>
                            <div class="layui-input-block">
                                <div id="toolbar" style="border: 1px solid #ccc; border-bottom: none; background: #fff; min-height: 40px;"></div>
                                <div id="editor" style="height:400px; border: 1px solid #ccc; background: #fff; position: relative;"></div>
                                <textarea id="content" name="content" style="display:none;">{$article.content|default=''}</textarea>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">排序</label>
                            <div class="layui-input-inline">
                                <input type="number" name="sort" value="{$article.sort}" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">状态</label>
                            <div class="layui-input-block">
                                <input type="radio" name="status" value="0" title="草稿" {if $article.status == 0}checked{/if}>
                                <input type="radio" name="status" value="1" title="发布" {if $article.status == 1}checked{/if}>
                                <input type="radio" name="status" value="2" title="下架" {if $article.status == 2}checked{/if}>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">置顶推荐</label>
                            <div class="layui-input-block">
                                <input type="checkbox" name="is_top" value="1" title="置顶" lay-skin="primary" {if $article.is_top}checked{/if}>
                                <input type="checkbox" name="is_recommend" value="1" title="推荐" lay-skin="primary" {if $article.is_recommend}checked{/if}>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn" lay-submit lay-filter="saveArticle">保存文章</button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                <button type="button" class="layui-btn layui-btn-normal" id="previewArticle">预览</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../../static/admin/js/jquery-3.7.1.min.js"></script>
<script src="/static/layui/layui.js"></script>
<script src="/static/wangeditor/index.js"></script>
<script>
$(document).ready(function() {
    layui.use(['form', 'layer', 'upload'], function(){
        var form = layui.form;
        var layer = layui.layer;
        var upload = layui.upload;
        
        // 检查WangEditor是否加载
        if (typeof window.wangEditor === 'undefined') {
            console.error('WangEditor未加载！');
            layer.msg('编辑器加载失败，请刷新页面重试', {icon: 2});
            return;
        }
        
        // 检查DOM元素是否存在
        var editorContainer = document.getElementById('editor');
        var toolbarContainer = document.getElementById('toolbar');
        
        if (!editorContainer || !toolbarContainer) {
            layer.msg('编辑器容器不存在，请检查页面结构', {icon: 2});
            return;
        }
        
        // 初始化富文本编辑器
        try {
            var editor = window.wangEditor.createEditor({
                selector: '#editor',
                html: '<p><br></p>',
                config: {
                    placeholder: '请输入文章内容...',
                    MENU_CONF: {
                        uploadImage: {
                            server: '/admin/upload/image',
                            fieldName: 'file',
                            customInsert: function(result, insertFn) {
                                if(result.code == 0){
                                    insertFn(result.data.url);
                                } else {
                                    layer.msg(result.msg, {icon: 2});
                                }
                            }
                        }
                    }
                }
            });
            
            // 创建工具栏
            var toolbar = window.wangEditor.createToolbar({
                editor: editor,
                selector: '#toolbar'
            });
            
            // 设置初始内容
            var initContent = $('textarea[name="content"]').val();
            if(initContent){
                editor.setHtml(initContent);
            }
            
        } catch (error) {
            console.error('编辑器初始化失败:', error);
            layer.msg('编辑器初始化失败: ' + error.message, {icon: 2});
            return;
        }
        
        // 图片上传
        upload.render({
            elem: '#uploadImage',
            url: '/admin/upload/image',
            accept: 'images',
            done: function(res){
                if(res.code == 0){
                    $('input[name="cover_image"]').val(res.data.url);
                    layer.msg('上传成功', {icon: 1});
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            }
        });
        
        // 保存文章
        form.on('submit(saveArticle)', function(data){
            data.field.content = editor.getHtml();
            
            if(!data.field.content){
                layer.msg('请输入文章内容', {icon: 2});
                return false;
            }
            
            var loadIndex = layer.load(1, {shade: [0.1, '#fff']});
            
            $.post('/admin/article/editArticle', data.field, function(res){
                layer.close(loadIndex);
                if(res.code == 0){
                    layer.msg(res.msg, {icon: 1}, function(){
                        // 关闭当前弹窗并刷新父页面
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                        parent.layui.table.reload('articleTable');
                    });
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            
            return false;
        });
        
        // 预览文章
        $('#previewArticle').on('click', function(){
            var title = $('input[name="title"]').val();
            var content = editor.getHtml();
            
            if(!title){
                layer.msg('请输入文章标题', {icon: 2});
                return;
            }
            
            if(!content){
                layer.msg('请输入文章内容', {icon: 2});
                return;
            }
            
            layer.open({
                type: 1,
                title: '文章预览',
                area: ['80%', '80%'],
                content: '<div style="padding: 20px;"><h1>' + title + '</h1><div>' + content + '</div></div>'
            });
        });
    });
});
</script>
</body>
</html> 