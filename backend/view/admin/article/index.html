{extend name="common/base" /}

{block name="title"}文章管理{/block}

{block name="content"}
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-blue">文章管理</span>
                    <div class="layui-btn-group layui-hide-xs" style="float: right;">
                        <button class="layui-btn layui-btn-sm" id="addArticle">
                            <i class="layui-icon layui-icon-add-1"></i> 添加文章
                        </button>
                        <button class="layui-btn layui-btn-sm layui-btn-normal" id="batchPublish">
                            <i class="layui-icon layui-icon-release"></i> 批量发布
                        </button>
                        <button class="layui-btn layui-btn-sm layui-btn-warm" id="batchUnpublish">
                            <i class="layui-icon layui-icon-pause"></i> 批量下架
                        </button>
                        <button class="layui-btn layui-btn-sm layui-btn-danger" id="batchDelete">
                            <i class="layui-icon layui-icon-delete"></i> 批量删除
                        </button>
                    </div>
                </div>
                <div class="layui-card-body">
                    <!-- 搜索条件 -->
                    <form class="layui-form layui-form-pane" lay-filter="searchForm">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">关键词</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="keyword" placeholder="标题或内容" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">分类</label>
                                <div class="layui-input-inline">
                                    <select name="category_id">
                                        <option value="">全部分类</option>
                                        {volist name="categories" id="category"}
                                        <option value="{$category.id}">{$category.name}</option>
                                        {/volist}
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">状态</label>
                                <div class="layui-input-inline">
                                    <select name="status">
                                        <option value="">全部状态</option>
                                        <option value="0">草稿</option>
                                        <option value="1">已发布</option>
                                        <option value="2">已下架</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn" lay-submit lay-filter="search">
                                    <i class="layui-icon layui-icon-search"></i> 搜索
                                </button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- 数据表格 -->
                    <table id="articleTable" lay-filter="articleTable"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 表格操作列模板 -->
<script type="text/html" id="tableBar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">预览</a>
    {{# if(d.status == 0) { }}
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="publish">发布</a>
    {{# } else if(d.status == 1) { }}
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="unpublish">下架</a>
    {{# } }}
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
</script>

<!-- 状态列模板 -->
<script type="text/html" id="statusTpl">
    {{# if(d.status == 0) { }}
    <span class="layui-badge layui-bg-gray">草稿</span>
    {{# } else if(d.status == 1) { }}
    <span class="layui-badge layui-bg-green">已发布</span>
    {{# } else if(d.status == 2) { }}
    <span class="layui-badge layui-bg-orange">已下架</span>
    {{# } }}
</script>

<!-- 置顶推荐列模板 -->
<script type="text/html" id="topRecommendTpl">
    {{# if(d.is_top == 1) { }}
    <span class="layui-badge layui-bg-red">置顶</span>
    {{# } }}
    {{# if(d.is_recommend == 1) { }}
    <span class="layui-badge layui-bg-blue">推荐</span>
    {{# } }}
</script>

<!-- 标签列模板 -->
<script type="text/html" id="tagsTpl">
    {{# layui.each(d.tags, function(index, item) { }}
    <span class="layui-badge" style="background-color: {{item.color}};">{{item.name}}</span>
    {{# }); }}
</script>

<!-- 复选框列模板 -->
<script type="text/html" id="checkboxTpl">
    <input type="checkbox" name="ids" value="{{d.id}}" lay-skin="primary" lay-filter="checkOne">
</script>
{/block}

{block name="script"}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 渲染表格
    var tableIns = table.render({
        elem: '#articleTable',
        url: '/admin/article/article',
        page: true,
        cols: [[
            {type: 'checkbox', fixed: 'left', templet: '#checkboxTpl'},
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'title', title: '标题', width: 500},
            {field: 'category', title: '分类', templet: function(d){
                return d.category ? d.category.name : '';
            }},
            {field: 'tags', title: '标签',  templet: '#tagsTpl'},
            {field: 'status', title: '状态',  templet: '#statusTpl'},
            {field: 'is_top', title: '置顶/推荐',  templet: '#topRecommendTpl'},
            {field: 'view_count', title: '浏览次数',  sort: true},
            {field: 'author', title: '作者',  templet: function(d){
                return d.author ? d.author.real_name : '';
            }},
            {field: 'create_time', title: '创建时间', sort: true},
            {title: '操作', width: 230, toolbar: '#tableBar', fixed: 'right'}
        ]],
        limits: [10, 20, 50, 100],
        limit: 10,
        height: 'full-220'
    });
    
    // 搜索
    form.on('submit(search)', function(data){
        tableIns.reload({
            where: data.field,
            page: {curr: 1}
        });
        return false;
    });
    
    // 表格工具栏事件
    table.on('tool(articleTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'edit'){
            layer.open({
                type: 2,
                title: '编辑文章',
                shadeClose: true,
                shade: 0.8,
                area: ['90%', '90%'],
                content: '/admin/article/editArticle?id=' + data.id
            });
        } else if(obj.event === 'view'){
            layer.open({
                type: 2,
                title: '预览文章',
                shadeClose: true,
                shade: 0.8,
                area: ['80%', '80%'],
                content: '/admin/article/viewArticle?id=' + data.id
            });
        } else if(obj.event === 'publish'){
            layer.confirm('确定要发布这篇文章吗？', function(index){
                $.post('/admin/article/publishArticle', {id: data.id}, function(res){
                    if(res.code == 0){
                        layer.msg(res.msg, {icon: 1});
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        } else if(obj.event === 'unpublish'){
            layer.confirm('确定要下架这篇文章吗？', function(index){
                $.post('/admin/article/unpublishArticle', {id: data.id}, function(res){
                    if(res.code == 0){
                        layer.msg(res.msg, {icon: 1});
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        } else if(obj.event === 'del'){
            layer.confirm('确定要删除这篇文章吗？', function(index){
                $.post('/admin/article/deleteArticle', {id: data.id}, function(res){
                    if(res.code == 0){
                        layer.msg(res.msg, {icon: 1});
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        }
    });
    
    // 添加文章
    $('#addArticle').on('click', function(){
        layer.open({
            type: 2,
            title: '添加文章',
            shadeClose: true,
            shade: 0.8,
            area: ['90%', '90%'],
            content: '/admin/article/addArticle'
        });
    });
    
    // 批量操作
    $('#batchPublish').on('click', function(){
        var ids = getCheckedIds();
        if(ids.length === 0){
            layer.msg('请选择要发布的文章', {icon: 2});
            return;
        }
        layer.confirm('确定要批量发布选中的文章吗？', function(index){
            $.post('/admin/article/batchArticle', {
                action: 'publish',
                ids: ids
            }, function(res){
                if(res.code == 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    });
    
    $('#batchUnpublish').on('click', function(){
        var ids = getCheckedIds();
        if(ids.length === 0){
            layer.msg('请选择要下架的文章', {icon: 2});
            return;
        }
        layer.confirm('确定要批量下架选中的文章吗？', function(index){
            $.post('/admin/article/batchArticle', {
                action: 'unpublish',
                ids: ids
            }, function(res){
                if(res.code == 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    });
    
    $('#batchDelete').on('click', function(){
        var ids = getCheckedIds();
        if(ids.length === 0){
            layer.msg('请选择要删除的文章', {icon: 2});
            return;
        }
        layer.confirm('确定要批量删除选中的文章吗？此操作不可恢复！', function(index){
            $.post('/admin/article/batchArticle', {
                action: 'delete',
                ids: ids
            }, function(res){
                if(res.code == 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    });
    
    // 监听窗口大小变化，重新调整表格高度
    $(window).on('resize', function(){
        tableIns.resize();
    });
});
</script>
{/block} 