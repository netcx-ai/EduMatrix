{extend name="common/base" /}

{block name="content"}
<div class="layui-card system-setting-page">
    <div class="layui-card-header">
        <div class="layui-row">
            <div class="layui-col-md6">
                <span class="layui-breadcrumb">
                    <a href="/admin/index/index">首页</a>
                    <a><cite>系统配置</cite></a>
                </span>
            </div>
            <div class="layui-col-md6 text-right">
                <a href="/admin/system_config/add?type={$type}" class="layui-btn layui-btn-normal">
                    <i class="layui-icon">&#xe654;</i> 添加配置
                </a>
            </div>
        </div>
    </div>
    <div class="layui-card-body">
        <div class="layui-tab">
            <ul class="layui-tab-title">
                {foreach $types as $key => $title}
                <li class="{$type==$key?'layui-this':''}">
                    <a href="/admin/system_config/index?type={$key}">{$title}</a>
                </li>
                {/foreach}
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <table class="layui-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>配置名称</th>
                                <th>服务商</th>
                                <th>状态</th>
                                <th>默认</th>
                                <th>备注</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {foreach $list as $item}
                            <tr>
                                <td>{$item.id}</td>
                                <td>{$item.name}</td>
                                <td>{$item.driver}</td>
                                <td>
                                    {if $item.status}
                                    <span class="layui-badge layui-bg-green">启用</span>
                                    {else}
                                    <span class="layui-badge">禁用</span>
                                    {/if}
                                </td>
                                <td>
                                    {if $item.is_default}
                                    <span class="layui-badge layui-bg-blue">默认</span>
                                    {else}
                                    <a href="javascript:;" class="layui-btn layui-btn-xs set-default" data-id="{$item.id}">设为默认</a>
                                    {/if}
                                </td>
                                <td>{$item.remark}</td>
                                <td>{$item.create_time|date='Y-m-d H:i:s'}</td>
                                <td>
                                    <a href="/admin/system_config/edit?id={$item.id}" class="layui-btn layui-btn-xs">编辑</a>
                                    <a href="javascript:;" class="layui-btn layui-btn-xs layui-btn-warm test-config" data-id="{$item.id}">测试</a>
                                    {if !$item.is_default}
                                    <a href="javascript:;" class="layui-btn layui-btn-xs layui-btn-danger delete" data-id="{$item.id}">删除</a>
                                    {/if}
                                </td>
                            </tr>
                            {/foreach}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script>
layui.use(['layer'], function(){
    var layer = layui.layer;
    
    // 删除
    $('.delete').click(function(){
        var id = $(this).data('id');
        layer.confirm('确定要删除吗？', function(index){
            $.post('/admin/system_config/delete', {id: id}, function(res){
                if(res.code == 1){
                    layer.msg(res.msg, {icon: 1}, function(){
                        location.reload();
                    });
                }else{
                    layer.msg(res.msg, {icon: 2});
                }
            });
        });
    });
    
    // 设置默认
    $('.set-default').click(function(){
        var id = $(this).data('id');
        $.post('/admin/system_config/setDefault', {id: id}, function(res){
            if(res.code == 1){
                layer.msg(res.msg, {icon: 1}, function(){
                    location.reload();
                });
            }else{
                layer.msg(res.msg, {icon: 2});
            }
        });
    });
    
    // 测试配置
    $('.test-config').click(function(){
        var id = $(this).data('id');
        var $btn = $(this);
        $btn.text('测试中...').prop('disabled', true);
        
        $.post('/admin/system_config/test', {id: id}, function(res){
            $btn.text('测试').prop('disabled', false);
            if(res.code == 1){
                layer.msg(res.msg, {icon: 1});
            }else{
                layer.msg(res.msg, {icon: 2});
            }
        }).fail(function(){
            $btn.text('测试').prop('disabled', false);
            layer.msg('测试失败，请检查网络连接', {icon: 2});
        });
    });
});
</script>
{/block} 