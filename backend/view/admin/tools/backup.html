{extend name="common/base" /}

{block name="title"}数据备份{/block}

{block name="content"}
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-blue">数据备份</span>
                </div>
                <div class="layui-card-body">
                    <!-- 备份操作 -->
                    <div class="layui-row">
                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">备份操作</div>
                                <div class="layui-card-body">
                                    <button class="layui-btn layui-btn-normal" id="createBackup">
                                        <i class="layui-icon layui-icon-download-circle"></i> 创建备份
                                    </button>
                                    <br><br>
                                    <p class="layui-text">
                                        <i class="layui-icon layui-icon-tips"></i>
                                        备份将包含所有数据库表结构和数据
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">备份信息</div>
                                <div class="layui-card-body">
                                    <p><strong>数据库类型：</strong>MySQL</p>
                                    <p><strong>备份位置：</strong>runtime/backup/</p>
                                    <p><strong>备份格式：</strong>SQL文件</p>
                                    <p><strong>注意事项：</strong>备份前请确保有足够磁盘空间</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 备份文件列表 -->
                    <div class="layui-row" style="margin-top: 20px;">
                        <div class="layui-col-md12">
                            <div class="layui-card">
                                <div class="layui-card-header">备份文件列表</div>
                                <div class="layui-card-body">
                                    <table id="backupTable" lay-filter="backupTable"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 表格操作列模板 -->
<script type="text/html" id="tableBar">
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="download">下载</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="restore">恢复</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
</script>
{/block}

{block name="script"}
<script>
layui.use(['table', 'layer'], function(){
    var table = layui.table;
    var layer = layui.layer;
    
    // 初始化表格
    var tableIns = table.render({
        elem: '#backupTable',
        url: '/admin/tools/backup',
        method: 'get',
        page: true,
        limit: 10,
        limits: [10, 20, 50],
        cols: [[
            {field: 'filename', title: '文件名'},
            {field: 'size', title: '文件大小', width: 150},
            {field: 'create_time', title: '创建时间'},
            {field: 'status', title: '状态', width: 100},
            {title: '操作', toolbar: '#tableBar', width: 200}
        ]],
        parseData: function(res){
            return {
                "code": res.code,
                "msg": res.msg,
                "count": res.count,
                "data": res.data
            };
        }
    });
    
    // 创建备份
    $('#createBackup').click(function(){
        layer.confirm('确定要创建数据备份吗？', function(index){
            var loadIndex = layer.load(1);
            
            $.post('/admin/tools/backup', {action: 'backup'}, function(res){
                layer.close(loadIndex);
                if(res.code == 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    });
    
    // 监听工具条
    table.on('tool(backupTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'download'){
            // 下载备份文件
            window.open('/admin/tools/backup?action=download&file=' + data.filename);
        } else if(obj.event === 'restore'){
            // 恢复备份
            layer.confirm('确定要恢复此备份吗？此操作将覆盖当前数据！', function(index){
                var loadIndex = layer.load(1);
                
                $.post('/admin/tools/backup', {
                    action: 'restore',
                    file: data.filename
                }, function(res){
                    layer.close(loadIndex);
                    if(res.code == 0){
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        } else if(obj.event === 'delete'){
            // 删除备份
            layer.confirm('确定要删除此备份文件吗？', function(index){
                var loadIndex = layer.load(1);
                
                $.post('/admin/tools/backup', {
                    action: 'delete',
                    file: data.filename
                }, function(res){
                    layer.close(loadIndex);
                    if(res.code == 0){
                        layer.msg(res.msg, {icon: 1});
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        }
    });
});
</script>
{/block} 