{extend name="common/base" /}

{block name="title"}系统监控{/block}

{block name="content"}
<div class="layui-fluid">
    <!-- 监控导航 -->
    <div class="layui-row">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div class="layui-btn-group">
                        <button type="button" class="layui-btn layui-btn-primary" data-type="system">系统信息</button>
                        <button type="button" class="layui-btn" data-type="database">数据库</button>
                        <button type="button" class="layui-btn" data-type="performance">性能监控</button>
                        <button type="button" class="layui-btn" data-type="storage">存储空间</button>
                    </div>
                    <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" style="float: right;" id="refreshBtn">
                        <i class="layui-icon layui-icon-refresh"></i> 刷新数据
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 系统信息 -->
    <div class="monitor-panel" id="systemPanel">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">服务器信息</div>
                    <div class="layui-card-body">
                        <table class="layui-table" lay-size="sm">
                            <tbody id="systemInfo">
                                <tr><td colspan="2" class="layui-text-center">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">PHP扩展</div>
                    <div class="layui-card-body">
                        <div id="extensionInfo">加载中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 数据库信息 -->
    <div class="monitor-panel" id="databasePanel" style="display: none;">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">数据库状态</div>
                    <div class="layui-card-body">
                        <table class="layui-table" lay-size="sm">
                            <tbody id="databaseInfo">
                                <tr><td colspan="2" class="layui-text-center">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">数据表信息</div>
                    <div class="layui-card-body">
                        <table class="layui-table" lay-size="sm">
                            <thead>
                                <tr>
                                    <th>表名</th>
                                    <th>记录数</th>
                                    <th>大小</th>
                                </tr>
                            </thead>
                            <tbody id="tableInfo">
                                <tr><td colspan="3" class="layui-text-center">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 性能监控 -->
    <div class="monitor-panel" id="performancePanel" style="display: none;">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md4">
                <div class="layui-card">
                    <div class="layui-card-header">内存使用</div>
                    <div class="layui-card-body">
                        <div id="memoryChart" style="height: 200px;"></div>
                        <div class="layui-text-center" id="memoryInfo">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-card">
                    <div class="layui-card-header">CPU使用率</div>
                    <div class="layui-card-body">
                        <div class="layui-text-center" style="padding: 50px 0;">
                            <h2 id="cpuUsage">-</h2>
                            <p>CPU使用率</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-card">
                    <div class="layui-card-header">系统负载</div>
                    <div class="layui-card-body">
                        <table class="layui-table" lay-size="sm">
                            <tbody id="loadInfo">
                                <tr><td colspan="2" class="layui-text-center">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 存储空间 -->
    <div class="monitor-panel" id="storagePanel" style="display: none;">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">磁盘使用情况</div>
                    <div class="layui-card-body">
                        <div id="diskChart" style="height: 300px;"></div>
                        <div id="diskInfo" class="layui-text-center">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header">目录大小</div>
                    <div class="layui-card-body">
                        <table class="layui-table" lay-size="sm">
                            <thead>
                                <tr>
                                    <th>目录</th>
                                    <th>大小</th>
                                </tr>
                            </thead>
                            <tbody id="directoryInfo">
                                <tr><td colspan="2" class="layui-text-center">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
layui.use(['layer'], function(){
    var layer = layui.layer;
    
    var memoryChart = echarts.init(document.getElementById('memoryChart'));
    var diskChart = echarts.init(document.getElementById('diskChart'));
    
    var currentType = 'system';
    
    // 切换监控面板
    $('.layui-btn-group button').click(function() {
        var type = $(this).data('type');
        $('.layui-btn-group button').removeClass('layui-btn-primary');
        $(this).addClass('layui-btn-primary');
        
        $('.monitor-panel').hide();
        $('#' + type + 'Panel').show();
        
        currentType = type;
        loadMonitorData(type);
    });
    
    // 刷新按钮
    $('#refreshBtn').click(function() {
        loadMonitorData(currentType);
    });
    
    // 加载监控数据
    function loadMonitorData(type) {
        $.post('/admin/tools/monitor', {
            type: type
        }, function(res) {
            if (res.code === 0) {
                switch (type) {
                    case 'system':
                        renderSystemInfo(res.data);
                        break;
                    case 'database':
                        renderDatabaseInfo(res.data);
                        break;
                    case 'performance':
                        renderPerformanceInfo(res.data);
                        break;
                    case 'storage':
                        renderStorageInfo(res.data);
                        break;
                }
            } else {
                layer.msg(res.msg || '加载失败', {icon: 2});
            }
        });
    }
    
    // 渲染系统信息
    function renderSystemInfo(data) {
        var html = '';
        html += '<tr><td>PHP版本</td><td>' + data.php_version + '</td></tr>';
        html += '<tr><td>服务器软件</td><td>' + data.server_software + '</td></tr>';
        html += '<tr><td>操作系统</td><td>' + data.operating_system + '</td></tr>';
        html += '<tr><td>服务器时间</td><td>' + data.server_time + '</td></tr>';
        html += '<tr><td>时区</td><td>' + data.timezone + '</td></tr>';
        html += '<tr><td>内存限制</td><td>' + data.memory_limit + '</td></tr>';
        html += '<tr><td>最大执行时间</td><td>' + data.max_execution_time + '秒</td></tr>';
        html += '<tr><td>上传文件大小限制</td><td>' + data.upload_max_filesize + '</td></tr>';
        html += '<tr><td>POST大小限制</td><td>' + data.post_max_size + '</td></tr>';
        
        $('#systemInfo').html(html);
        
        // 渲染扩展信息
        var extHtml = '';
        for (var ext in data.extensions) {
            var status = data.extensions[ext] ? '<span class="layui-badge layui-bg-green">已安装</span>' : '<span class="layui-badge">未安装</span>';
            extHtml += '<p>' + ext + ': ' + status + '</p>';
        }
        $('#extensionInfo').html(extHtml);
    }
    
    // 渲染数据库信息
    function renderDatabaseInfo(data) {
        var html = '';
        html += '<tr><td>数据库版本</td><td>' + data.version + '</td></tr>';
        html += '<tr><td>数据库名称</td><td>' + data.database_name + '</td></tr>';
        html += '<tr><td>数据库大小</td><td>' + data.database_size + '</td></tr>';
        html += '<tr><td>连接状态</td><td>' + data.connection_status + '</td></tr>';
        
        $('#databaseInfo').html(html);
        
        // 渲染表信息
        var tableHtml = '';
        if (data.tables && data.tables.length > 0) {
            data.tables.forEach(function(table) {
                tableHtml += '<tr><td>' + table.table_name + '</td><td>' + table.table_rows + '</td><td>' + table.size_mb + ' MB</td></tr>';
            });
        } else {
            tableHtml = '<tr><td colspan="3" class="layui-text-center">暂无数据</td></tr>';
        }
        $('#tableInfo').html(tableHtml);
    }
    
    // 渲染性能信息
    function renderPerformanceInfo(data) {
        // CPU使用率
        $('#cpuUsage').text(data.cpu_usage || 'N/A');
        
        // 系统负载
        var loadHtml = '';
        loadHtml += '<tr><td>系统负载</td><td>' + data.load_average + '</td></tr>';
        loadHtml += '<tr><td>系统运行时间</td><td>' + data.uptime + '</td></tr>';
        loadHtml += '<tr><td>进程数量</td><td>' + data.processes + '</td></tr>';
        $('#loadInfo').html(loadHtml);
        
        // 内存使用图表
        if (data.memory_usage) {
            var memoryInfo = '当前: ' + data.memory_usage.current + ' | 峰值: ' + data.memory_usage.peak + ' | 限制: ' + data.memory_usage.limit;
            $('#memoryInfo').text(memoryInfo);
            
            // 简单的内存使用显示
            var memoryOption = {
                tooltip: {
                    formatter: '{a} <br/>{b}: {c}%'
                },
                series: [
                    {
                        name: '内存使用',
                        type: 'gauge',
                        detail: {formatter: '{value}%'},
                        data: [{value: 50, name: '内存使用率'}] // 这里需要计算实际使用率
                    }
                ]
            };
            memoryChart.setOption(memoryOption);
        }
    }
    
    // 渲染存储信息
    function renderStorageInfo(data) {
        // 磁盘信息
        var diskInfo = '总空间: ' + data.disk_total + ' | 已用: ' + data.disk_used + ' | 可用: ' + data.disk_free;
        $('#diskInfo').text(diskInfo);
        
        // 磁盘使用图表
        var diskOption = {
            tooltip: {
                trigger: 'item'
            },
            series: [
                {
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        {value: parseFloat(data.disk_used), name: '已使用'},
                        {value: parseFloat(data.disk_free), name: '可用空间'}
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        diskChart.setOption(diskOption);
        
        // 目录信息
        var dirHtml = '';
        if (data.directories) {
            for (var dir in data.directories) {
                dirHtml += '<tr><td>' + data.directories[dir].path + '</td><td>' + data.directories[dir].size + '</td></tr>';
            }
        }
        $('#directoryInfo').html(dirHtml);
    }
    
    // 初始化加载系统信息
    loadMonitorData('system');
    
    // 响应式处理
    window.addEventListener('resize', function() {
        memoryChart.resize();
        diskChart.resize();
    });
});
</script>

<style>
.monitor-panel {
    margin-top: 15px;
}
</style>
{/block} 