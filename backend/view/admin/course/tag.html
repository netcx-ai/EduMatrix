{extend name="common/base" /}

{block name="content"}
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span>课程标签管理</span>
                    <button class="layui-btn layui-btn-sm layui-btn-normal" style="float: right;" onclick="addTag()">
                        <i class="layui-icon layui-icon-add-1"></i> 添加标签
                    </button>
                </div>
                <div class="layui-card-body">
                    <!-- 搜索条件 -->
                    <form class="layui-form layui-form-pane" lay-filter="searchForm">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">关键词</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="keyword" placeholder="标签名称或描述" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">状态</label>
                                <div class="layui-input-inline">
                                    <select name="status">
                                        <option value="">全部</option>
                                        <option value="1">启用</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn" lay-submit lay-filter="search">
                                    <i class="layui-icon layui-icon-search"></i> 搜索
                                </button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- 数据表格 -->
                    <table id="tagTable" lay-filter="tagTable"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 操作列模板 -->
<script type="text/html" id="operationTpl">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
</script>

<!-- 状态列模板 -->
<script type="text/html" id="statusTpl">
    {{# if(d.status == 1){ }}
        <span class="layui-badge layui-bg-green">启用</span>
    {{# } else { }}
        <span class="layui-badge" style="background-color: #999999;">禁用</span>
    {{# } }}
</script>

<!-- 标签颜色模板 -->
<script type="text/html" id="colorTpl">
    <span class="layui-badge" style="background-color: {{d.color}};">{{d.name}}</span>
</script>

<!-- 课程数量模板 -->
<script type="text/html" id="contentCountTpl">
    <span class="layui-badge layui-bg-blue">{{d.courses_count || 0}}</span>
</script>
{/block}

{block name="script"}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 渲染表格
    var tableIns = table.render({
        elem: '#tagTable',
        url: '/admin/course/tag',
        method: 'post',
        page: true,
        cols: [[
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'name', title: '标签名称', width: 150, templet: '#colorTpl'},
            {field: 'description', title: '描述', width: 200},
            {field: 'courses_count', title: '关联课程', width: 100, templet: '#contentCountTpl'},
            {field: 'sort', title: '排序', width: 80, sort: true},
            {field: 'status', title: '状态', width: 100, templet: '#statusTpl'},
            {field: 'create_time', title: '创建时间', width: 160},
            {title: '操作', width: 150, toolbar: '#operationTpl', fixed: 'right'}
        ]],
        limits: [10, 20, 50, 100],
        limit: 20
    });
    
    // 搜索
    form.on('submit(search)', function(data){
        tableIns.reload({
            where: data.field,
            page: {curr: 1}
        });
        return false;
    });
    
    // 监听工具条
    table.on('tool(tagTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'edit'){
            editTag(data.id);
        } else if(obj.event === 'delete'){
            deleteTag(data.id, data.name);
        }
    });
    
    // 添加标签
    window.addTag = function(){
        layer.open({
            type: 2,
            title: '添加标签',
            shadeClose: true,
            shade: 0.8,
            area: ['500px', '400px'],
            content: '/admin/course/addTag'
        });
    };
    
    // 编辑标签
    window.editTag = function(id){
        layer.open({
            type: 2,
            title: '编辑标签',
            shadeClose: true,
            shade: 0.8,
            area: ['500px', '400px'],
            content: '/admin/course/editTag?id=' + id
        });
    };
    
    // 删除标签
    window.deleteTag = function(id, name){
        layer.confirm('确定要删除标签 "' + name + '" 吗？', function(index){
            $.post('/admin/course/deleteTag', {id: id}, function(res){
                if(res.code === 0){
                    layer.msg('删除成功', {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg || '删除失败', {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 监听子页面刷新
    window.refreshTable = function(){
        tableIns.reload();
    };
});
</script>
{/block} 