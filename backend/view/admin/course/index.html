{extend name="common/base" /}

{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">
        <div class="layui-row">
            <div class="layui-col-md6">
                <span class="layui-breadcrumb">
                    <a href="/admin/index/index">首页</a>
                    <a><cite>课程管理</cite></a>
                </span>
            </div>
            <div class="layui-col-md6 text-right">
                <button class="layui-btn layui-btn-normal" id="addCourseBtn">
                    <i class="layui-icon">&#xe654;</i> 添加课程
                </button>
            </div>
        </div>
    </div>
    <div class="layui-card-body">
        <!-- 搜索栏 -->
        <div class="layui-form layui-form-pane" style="margin-bottom: 15px;">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">关键词</label>
                    <div class="layui-input-inline">
                        <input type="text" name="keyword" placeholder="课程名称/代码/简介" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">学校</label>
                    <div class="layui-input-inline">
                        <select name="school_id" lay-filter="school">
                            <option value="">全部学校</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">学院</label>
                    <div class="layui-input-inline">
                        <select name="college_id" lay-filter="college">
                            <option value="">全部学院</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">负责教师</label>
                    <div class="layui-input-inline">
                        <select name="responsible_teacher_id">
                            <option value="">全部教师</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-inline">
                        <select name="status">
                            <option value="">全部</option>
                            <option value="1">启用</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">公开性</label>
                    <div class="layui-input-inline">
                        <select name="is_public">
                            <option value="">全部</option>
                            <option value="1">公开</option>
                            <option value="0">私有</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn" lay-submit lay-filter="search">
                        <i class="layui-icon">&#xe615;</i> 搜索
                    </button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <table id="courseTable" lay-filter="courseTable"></table>
    </div>
</div>

<!-- 操作按钮模板 -->
<script type="text/html" id="operationBar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="detail">详情</a>
    <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="tags">标签</a>
    {{# if(d.status == 1) { }}
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="disable">禁用</a>
    {{# } else if(d.status == 0) { }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="enable">启用</a>
    {{# } else if(d.status == 2) { }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="approve">审核</a>
    {{# } }}
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
</script>

<!-- 状态模板 -->
<script type="text/html" id="statusTpl">
    {{# if(d.status == 1) { }}
    <span class="layui-badge layui-bg-green">启用</span>
    {{# } else if(d.status == 0) { }}
    <span class="layui-badge">禁用</span>
    {{# } else if(d.status == 2) { }}
    <span class="layui-badge layui-bg-orange">待审核</span>
    {{# } }}
</script>

<!-- 课程类型模板 -->
<script type="text/html" id="courseTypeTpl">
    {{# if(d.course_type == 1) { }}
    <span>必修课</span>
    {{# } else if(d.course_type == 2) { }}
    <span>选修课</span>
    {{# } else if(d.course_type == 3) { }}
    <span>公共课</span>
    {{# } else if(d.course_type == 4) { }}
    <span>专业课</span>
    {{# } else if(d.course_type == 5) { }}
    <span>其他</span>
    {{# } }}
</script>

<!-- 难度等级模板 -->
<script type="text/html" id="difficultyTpl">
    {{# if(d.difficulty == 1) { }}
    <span class="layui-badge layui-bg-green">初级</span>
    {{# } else if(d.difficulty == 2) { }}
    <span class="layui-badge layui-bg-orange">中级</span>
    {{# } else if(d.difficulty == 3) { }}
    <span class="layui-badge layui-bg-red">高级</span>
    {{# } }}
</script>

<!-- 学校名称模板 -->
<script type="text/html" id="schoolTpl">
    {{# if(d.school && d.school.name) { }}
    <span>{{d.school.name}}</span>
    {{# } else { }}
    <span class="layui-text-color">未设置</span>
    {{# } }}
</script>

<!-- 学院名称模板 -->
<script type="text/html" id="collegeTpl">
    {{# if(d.college && d.college.name) { }}
    <span>{{d.college.name}}</span>
    {{# } else { }}
    <span class="layui-text-color">未设置</span>
    {{# } }}
</script>

<!-- 教师名称模板 -->
<script type="text/html" id="teacherTpl">
    {{# if(d.responsible_teacher && d.responsible_teacher.real_name) { }}
    <span>{{d.responsible_teacher.real_name}}</span>
    {{# } else { }}
    <span class="layui-text-color">未设置</span>
    {{# } }}
</script>

<!-- 标签模板 -->
<script type="text/html" id="tagsTpl">
    {{# if(d.tags && d.tags.length > 0) { }}
        {{# layui.each(d.tags, function(index, item) { }}
            <span class="layui-badge" style="background-color: {{item.color}}; margin-right: 5px;">{{item.name}}</span>
        {{# }); }}
    {{# } else { }}
        <span class="layui-text-color">无标签</span>
    {{# } }}
</script>

<!-- 公开性模板 -->
<script type="text/html" id="publicTpl">
    {{# if(d.is_public == 1) { }}
    <span class="layui-badge layui-bg-green">公开</span>
    {{# } else { }}
    <span class="layui-badge">私有</span>
    {{# } }}
</script>
{/block}

{block name="script"}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 渲染表格
    var tableIns = table.render({
        elem: '#courseTable',
        url: '/admin/course/index',
        page: true,
        cols: [[
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'name', title: '课程名称'},
            {field: 'course_code', title: '课程代码'},
            {field: 'college.name', title: '所属学院', templet: '#collegeTpl'},
            {field: 'responsible_teacher.real_name', title: '负责教师', width: 100, templet: '#teacherTpl'},
            {field: 'credits', title: '学分',  align: 'center'},
            {field: 'hours', title: '学时',  align: 'center'},
            {field: 'create_count', title: '内容数量',  align: 'center'},
            {field: 'tags', title: '标签', templet: '#tagsTpl'},
            {field: 'is_public', title: '公开性', templet: '#publicTpl'},
            {field: 'status', title: '状态', templet: '#statusTpl'},
            {field: 'create_time', title: '创建时间'},
            {title: '操作', toolbar: '#operationBar', fixed: 'right'}
        ]],
        limits: [10, 20, 50, 100],
        limit: 20
    });
    
    // 搜索
    form.on('submit(search)', function(data){
        tableIns.reload({
            where: data.field,
            page: {curr: 1}
        });
        return false;
    });
    
    // 监听工具条
    table.on('tool(courseTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'edit'){
            layer.open({
                type: 2,
                title: '编辑课程',
                shadeClose: true,
                shade: 0.8,
                area: ['900px', '700px'],
                content: '/admin/course/edit?id=' + data.id
            });
        } else if(obj.event === 'detail'){
            layer.open({
                type: 2,
                title: '课程详情',
                shadeClose: true,
                shade: 0.8,
                area: ['900px', '700px'],
                content: '/admin/course/detail?id=' + data.id
            });
        } else if(obj.event === 'tags'){
            layer.open({
                type: 2,
                title: '课程标签管理',
                shadeClose: true,
                shade: 0.8,
                area: ['600px', '500px'],
                content: '/admin/course/tags?id=' + data.id
            });
        } else if(obj.event === 'del'){
            layer.confirm('确定删除此课程？', function(index){
                $.post('/admin/course/delete', {id: data.id}, function(res){
                    if(res.code === 0){
                        layer.msg('删除成功');
                        obj.del();
                    } else {
                        layer.msg(res.msg || '删除失败');
                    }
                });
                layer.close(index);
            });
        } else if(obj.event === 'disable'){
            layer.confirm('确定禁用此课程？', function(index){
                $.post('/admin/course/changeStatus', {id: data.id, status: 0}, function(res){
                    if(res.code === 0){
                        layer.msg('禁用成功');
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg || '禁用失败');
                    }
                });
                layer.close(index);
            });
        } else if(obj.event === 'enable'){
            layer.confirm('确定启用此课程？', function(index){
                $.post('/admin/course/changeStatus', {id: data.id, status: 1}, function(res){
                    if(res.code === 0){
                        layer.msg('启用成功');
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg || '启用失败');
                    }
                });
                layer.close(index);
            });
        } else if(obj.event === 'approve'){
            layer.confirm('确定审核通过此课程？', function(index){
                $.post('/admin/course/changeStatus', {id: data.id, status: 1}, function(res){
                    if(res.code === 0){
                        layer.msg('审核成功');
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg || '审核失败');
                    }
                });
                layer.close(index);
            });
        }
    });
    
    // 添加课程按钮点击事件
    $('#addCourseBtn').click(function(){
        layer.open({
            type: 2,
            title: '添加课程',
            shadeClose: true,
            shade: 0.8,
            area: ['900px', '700px'],
            content: '/admin/course/add'
        });
    });
    
    // 加载学校数据
    $.get('/admin/school/getList', function(res){
        if(res.code === 0){
            var html = '<option value="">全部学校</option>';
            res.data.list.forEach(function(item){
                html += '<option value="' + item.id + '">' + item.name + '</option>';
            });
            $('select[name="school_id"]').html(html);
            form.render('select');
        }
    });
    
    // 学校变化时加载学院
    form.on('select(school)', function(data){
        var schoolId = data.value;
        if(schoolId){
            $.get('/admin/college/getList', {school_id: schoolId}, function(res){
                if(res.code === 0){
                    var html = '<option value="">全部学院</option>';
                    res.data.list.forEach(function(item){
                        html += '<option value="' + item.id + '">' + item.name + '</option>';
                    });
                    $('select[name="college_id"]').html(html);
                    form.render('select');
                    // 清空教师选择
                    $('select[name="teacher_id"]').html('<option value="">全部教师</option>');
                    form.render('select');
                }
            });
        } else {
            $('select[name="college_id"]').html('<option value="">全部学院</option>');
            $('select[name="teacher_id"]').html('<option value="">全部教师</option>');
            form.render('select');
        }
    });
    
    // 学院变化时加载教师
    form.on('select(college)', function(data){
        var collegeId = data.value;
        if(collegeId){
            $.get('/admin/teacher/getList', {college_id: collegeId}, function(res){
                if(res.code === 0){
                    var html = '<option value="">全部教师</option>';
                    res.data.list.forEach(function(item){
                        html += '<option value="' + item.id + '">' + item.real_name + '</option>';
                    });
                    $('select[name="responsible_teacher_id"]').html(html);
                    form.render('select');
                }
            });
        } else {
            $('select[name="responsible_teacher_id"]').html('<option value="">全部教师</option>');
            form.render('select');
        }
    });
});
</script>
{/block} 
{/block} 