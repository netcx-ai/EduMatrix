{extend name="common/base" /}

{block name="content"}
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <!-- 总体统计 -->
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-blue">总体统计</span>
                </div>
                <div class="layui-card-body">
                    <div class="layui-row">
                        <div class="layui-col-md2">
                            <div class="layui-card" style="text-align: center;">
                                <div class="layui-card-body">
                                    <h3 style="color: #1E9FFF;">{$overview.total}</h3>
                                    <p>总内容数</p>
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-md2">
                            <div class="layui-card" style="text-align: center;">
                                <div class="layui-card-body">
                                    <h3 style="color: #FFB800;">{$overview.draft}</h3>
                                    <p>草稿</p>
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-md2">
                            <div class="layui-card" style="text-align: center;">
                                <div class="layui-card-body">
                                    <h3 style="color: #FF5722;">{$overview.pending}</h3>
                                    <p>待审核</p>
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-md2">
                            <div class="layui-card" style="text-align: center;">
                                <div class="layui-card-body">
                                    <h3 style="color: #5FB878;">{$overview.approved}</h3>
                                    <p>已通过</p>
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-md2">
                            <div class="layui-card" style="text-align: center;">
                                <div class="layui-card-body">
                                    <h3 style="color: #FF5722;">{$overview.rejected}</h3>
                                    <p>已驳回</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 图表统计 -->
        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-green">按来源类型统计</span>
                </div>
                <div class="layui-card-body">
                    <div id="sourceTypeChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        
        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-orange">按状态统计</span>
                </div>
                <div class="layui-card-body">
                    <div id="statusChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        
        <!-- 学校统计 -->
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-purple">按学校统计（Top 10）</span>
                </div>
                <div class="layui-card-body">
                    <div id="schoolChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        
        <!-- 最近7天统计 -->
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-cyan">最近7天创建统计</span>
                </div>
                <div class="layui-card-body">
                    <div id="recentChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
// 准备图表数据
var sourceTypeStats = {:json_encode($sourceTypeStats)};
var statusStats = {:json_encode($statusStats)};
var schoolStats = {:json_encode($schoolStats)};
var recentStats = {:json_encode($recentStats)};

layui.use(['layer'], function(){
    var layer = layui.layer;
    
    // 状态统计图表
    var statusChart = echarts.init(document.getElementById('statusChart'));
    var statusOption = {
        title: {
            text: '状态分布',
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [{
            name: '状态',
            type: 'pie',
            radius: '50%',
            data: statusStats.map(function(item) {
                return {
                    value: item.count,
                    name: item.status
                };
            })
        }]
    };
    statusChart.setOption(statusOption);

    // 来源类型统计图表
    var sourceTypeChart = echarts.init(document.getElementById('sourceTypeChart'));
    var sourceTypeOption = {
        title: {
            text: '来源类型分布',
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [{
            name: '来源类型',
            type: 'pie',
            radius: '50%',
            data: sourceTypeStats.map(function(item) {
                return {
                    value: item.count,
                    name: item.source_type
                };
            })
        }]
    };
    sourceTypeChart.setOption(sourceTypeOption);

    // 学校统计图表
    var schoolChart = echarts.init(document.getElementById('schoolChart'));
    var schoolOption = {
        title: {
            text: '各学校内容数量',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        xAxis: {
            type: 'category',
            data: schoolStats.map(function(item) {
                return item.school_name;
            }),
            axisLabel: {
                rotate: 45
            }
        },
        yAxis: {
            type: 'value'
        },
        series: [{
            name: '内容数量',
            type: 'bar',
            data: schoolStats.map(function(item) {
                return item.count;
            })
        }]
    };
    schoolChart.setOption(schoolOption);

    // 最近7天统计图表
    var recentChart = echarts.init(document.getElementById('recentChart'));
    var recentOption = {
        title: {
            text: '最近7天内容创建趋势',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis'
        },
        xAxis: {
            type: 'category',
            data: recentStats.map(function(item) {
                return item.date;
            })
        },
        yAxis: {
            type: 'value'
        },
        series: [{
            name: '创建数量',
            type: 'line',
            data: recentStats.map(function(item) {
                return item.count;
            }),
            smooth: true
        }]
    };
    recentChart.setOption(recentOption);

    // 窗口大小改变时重新调整图表大小
    window.addEventListener('resize', function() {
        sourceTypeChart.resize();
        statusChart.resize();
        schoolChart.resize();
        recentChart.resize();
    });
});
</script>
{/block}
