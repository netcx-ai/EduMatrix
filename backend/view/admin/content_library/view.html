<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>内容详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="/static/layui/css/layui.css" media="all">
</head>
<body style="padding: 15px;">
    <div class="layui-card">
        <div class="layui-card-header">
            <h2>内容详情</h2>
            {if $content.status == 'pending'}
            <div style="float:right;">
                <button class="layui-btn layui-btn-normal layui-btn-sm" onclick="approveContent({$content.id})">
                    <i class="layui-icon layui-icon-ok"></i> 通过
                </button>
                <button class="layui-btn layui-btn-warm layui-btn-sm" onclick="rejectContent({$content.id})">
                    <i class="layui-icon layui-icon-close"></i> 驳回
                </button>
            </div>
            {/if}
        </div>
        <div class="layui-card-body">
            <table class="layui-table">
                <tbody>
                    <tr>
                        <td>内容名称</td>
                        <td>{$content.name|default='-'}</td>
                        <td>文件类型</td>
                        <td>
                            {if condition="$content.file_type == 'text'"}
                                <span class="layui-badge layui-bg-blue">文本</span>
                            {elseif condition="$content.file_type == 'document'"}
                                <span class="layui-badge layui-bg-green">文档</span>
                            {elseif condition="$content.file_type == 'image'"}
                                <span class="layui-badge layui-bg-orange">图片</span>
                            {elseif condition="$content.file_type == 'video'"}
                                <span class="layui-badge layui-bg-red">视频</span>
                            {else/}
                                <span class="layui-badge layui-bg-gray">未知</span>
                            {/if}
                        </td>
                    </tr>
                    <tr>
                        <td>来源类型</td>
                        <td>
                            {if condition="$content.source_type == 'upload'"}
                                <span class="layui-badge layui-bg-blue">文件上传</span>
                            {elseif condition="$content.source_type == 'ai_generate'"}
                                <span class="layui-badge layui-bg-purple">AI生成</span>
                            {else/}
                                <span class="layui-badge layui-bg-gray">未知</span>
                            {/if}
                        </td>
                        <td>状态</td>
                        <td>
                            {if condition="$content.status == 'draft'"}
                                <span class="layui-badge layui-bg-gray">草稿</span>
                            {elseif condition="$content.status == 'pending'"}
                                <span class="layui-badge layui-bg-orange">待审核</span>
                            {elseif condition="$content.status == 'approved'"}
                                <span class="layui-badge layui-bg-green">已通过</span>
                            {elseif condition="$content.status == 'rejected'"}
                                <span class="layui-badge layui-bg-red">已驳回</span>
                            {else/}
                                <span class="layui-badge layui-bg-gray">未知</span>
                            {/if}
                        </td>
                    </tr>
                    <tr>
                        <td>创建者</td>
                        <td>{$content.creator_name|default='-'}</td>
                        <td>所属学校</td>
                        <td>{$content.school_name|default='-'}</td>
                    </tr>
                    <tr>
                        <td>所属学院</td>
                        <td>{$content.college_name|default='-'}</td>
                        <td>关联课程</td>
                        <td>
                            {if $content.course_id}
                                <a href="/admin/course/detail?id={$content.course_id}" target="_blank" class="layui-text">{$content.course.name|default='未知课程'}</a>
                            {else/}
                                <span class="layui-text-color">暂无关联</span>
                            {/if}
                        </td>
                    </tr>
                    <tr>
                        <td>创建时间</td>
                        <td>{$content.create_time_text|default='-'}</td>
                        <td>更新时间</td>
                        <td>{$content.update_time_text|default='-'}</td>
                    </tr>
                    {if $content.audit_user_id}
                    <tr>
                        <td>审核人</td>
                        <td>{$content.audit_user_name|default='-'}</td>
                        <td>审核时间</td>
                        <td>{$content.audit_time_text|default='-'}</td>
                    </tr>
                    <tr>
                        <td colspan="4">审核备注</td>
                    </tr>
                    <tr>
                        <td colspan="4">{$content.audit_remark|default='无'}</td>
                    </tr>
                    {/if}
                    <tr>
                        <td colspan="4">关联文件</td>
                    </tr>
                    <tr>
                        <td colspan="4">
                            {if condition="$content.files && count($content.files) > 0"}
                                <div style="padding: 10px 0;">
                                    {volist name="content.files" id="file"}
                                    <div style="margin-bottom: 10px; padding: 8px; border: 1px solid #e6e6e6; border-radius: 2px; background: #fafafa;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>{$file.file_name}</strong>
                                            <span style="color: #999; font-size: 12px; margin-left: 10px;">
                                                {$file.file_size_text|default='0 B'} | {$file.file_type|default='未知'}
                                            </span>
                                        </div>
                                                                        <div>
                                    <a href="javascript:;" onclick="downloadFile({$file.id}, '{$file.file_name}')" class="layui-btn layui-btn-xs layui-btn-normal">
                                        <i class="layui-icon layui-icon-download-circle"></i> 下载
                                    </a>
                                    {if condition="$file.file_type == 'image'"}
                                    <a href="javascript:;" onclick="previewImage('{$file.file_url}')" class="layui-btn layui-btn-xs layui-btn-primary">
                                        <i class="layui-icon layui-icon-picture"></i> 预览
                                    </a>
                                    {/if}
                                </div>
                                    </div>
                                    {/volist}
                                </div>
                            {else/}
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    <i class="layui-icon layui-icon-face-cry" style="font-size: 24px;"></i>
                                    <p>暂无关联文件</p>
                                </div>
                            {/if}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4">内容预览</td>
                    </tr>
                    <tr>
                        <td colspan="4">
                            {if $content.file_type == 'text'}
                                <div style="position: relative;">
                                    {if $content.is_json}
                                    <button class="layui-btn layui-btn-xs layui-btn-primary" style="float:right; margin-bottom: 10px;" onclick="toggleJsonFormat()">
                                        <span id="formatToggle">格式化显示</span>
                                    </button>
                                    <div style="clear: both;"></div>
                                    {/if}
                                    <div class="content-preview" id="contentPreview">{$content.content|default='暂无内容'}</div>
                                </div>
                            {elseif $content.file_type == 'image'}
                                {if $content.file_url}
                                <div style="text-align: center; padding: 20px;">
                                    <img src="{$content.file_url}" style="max-width: 100%; max-height: 400px; border: 1px solid #e6e6e6;" alt="{$content.name|default='图片预览'}">
                                </div>
                                {else}
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    <i class="layui-icon layui-icon-picture" style="font-size: 24px;"></i>
                                    <p>暂无图片</p>
                                </div>
                                {/if}
                            {elseif $content.file_type == 'video'}
                                {if $content.file_url}
                                <div style="text-align: center; padding: 20px;">
                                    <video src="{$content.file_url}" controls style="max-width: 100%; max-height: 400px;"></video>
                                </div>
                                {else}
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    <i class="layui-icon layui-icon-video" style="font-size: 24px;"></i>
                                    <p>暂无视频</p>
                                </div>
                                {/if}
                            {else}
                                {if $content.file_url}
                                <div style="text-align: center; padding: 20px;">
                                    <a href="{$content.file_url}" class="layui-btn layui-btn-normal" target="_blank">
                                        <i class="layui-icon layui-icon-download-circle"></i> 下载查看
                                    </a>
                                </div>
                                {else}
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    <i class="layui-icon layui-icon-file" style="font-size: 24px;"></i>
                                    <p>暂无文件</p>
                                </div>
                                {/if}
                            {/if}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="layui-form-item" style="margin-top: 20px; text-align: center;">
        <button type="button" class="layui-btn layui-btn-primary" onclick="closeWindow()">关闭</button>
    </div>

    <style>
    .content-preview {
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
        background: #fafafa;
        border: 1px solid #e6e6e6;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-all;
    }
    </style>
    
    <script src="/static/admin/js/jquery-3.7.1.min.js"></script>
    <script src="/static/layui/layui.js"></script>
    <script>
    layui.use(['layer'], function(){
        var layer = layui.layer;
        var isFormatted = false;
        var originalContent = {$content.content|json_encode|raw};
        
        window.closeWindow = function() {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        };
        
        // JSON格式化切换
        window.toggleJsonFormat = function() {
            var preview = document.getElementById('contentPreview');
            var toggle = document.getElementById('formatToggle');
            
            if (!isFormatted) {
                try {
                    var jsonData = JSON.parse(originalContent);
                    var formatted = JSON.stringify(jsonData, null, 2);
                    preview.innerHTML = '<pre style="margin: 0; font-family: Monaco, Consolas, \'Courier New\', monospace;">' + formatted + '</pre>';
                    toggle.textContent = '原始显示';
                    isFormatted = true;
                } catch (e) {
                    layer.msg('JSON格式错误', {icon: 2});
                }
            } else {
                preview.innerHTML = originalContent.replace(/\n/g, '<br>');
                toggle.textContent = '格式化显示';
                isFormatted = false;
            }
        };
        
        // 图片预览
        window.previewImage = function(url) {
            layer.photos({
                photos: {
                    "data": [{
                        "src": url,
                        "alt": "图片预览"
                    }]
                },
                anim: 5
            });
        };
        
        // 文件下载（参照前端API方式）
        window.downloadFile = function(fileId, fileName) {
            try {
                const downloadUrl = '/admin/file/download?id=' + fileId;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName || 'download';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                layer.msg('开始下载文件', {icon: 1});
            } catch (error) {
                console.error('下载失败：', error);
                layer.msg('下载失败', {icon: 2});
            }
        };
        
        // 审核通过
        window.approveContent = function(id){
            layer.prompt({
                title: '请输入审核备注（可选）',
                formType: 2,
                value: '内容审核通过'
            }, function(remark, index){
                $.post('/admin/content_library/auditAction', {
                    id: id,
                    action: 'approve',
                    remark: remark
                }, function(res){
                    if(res.code === 0){
                        layer.msg(res.msg, {icon: 1}, function(){
                            var frameIndex = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(frameIndex);
                            if (parent.layui && parent.layui.table) {
                                parent.layui.table.reload('contentTable');
                            }
                        });
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        };

        // 审核驳回
        window.rejectContent = function(id){
            layer.prompt({
                title: '请输入驳回原因',
                formType: 2,
                value: '内容不符合要求'
            }, function(remark, index){
                $.post('/admin/content_library/auditAction', {
                    id: id,
                    action: 'reject',
                    remark: remark
                }, function(res){
                    if(res.code === 0){
                        layer.msg(res.msg, {icon: 1}, function(){
                            var frameIndex = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(frameIndex);
                            if (parent.layui && parent.layui.table) {
                                parent.layui.table.reload('contentTable');
                            }
                        });
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        };
    });
    </script>
</body>
</html>

