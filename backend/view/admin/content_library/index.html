{extend name="common/base" /}

{block name="content"}
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-badge layui-bg-blue">内容库管理</span>
                </div>
                <div class="layui-card-body">
                    <!-- 搜索条件 -->
                    <form class="layui-form layui-form-pane" lay-filter="searchForm">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">关键词</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="keyword" placeholder="内容名称或内容" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">关联课程</label>
                                <div class="layui-input-inline">
                                    <select name="course_id">
                                        <option value="">全部课程</option>
                                        {volist name="courses" id="course"}
                                        <option value="{$course.id}">{$course.name}</option>
                                        {/volist}
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">来源类型</label>
                                <div class="layui-input-inline">
                                    <select name="source_type">
                                        <option value="">全部来源</option>
                                        {volist name="sourceTypes" id="type"}
                                        <option value="{$key}">{$type}</option>
                                        {/volist}
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">状态</label>
                                <div class="layui-input-inline">
                                    <select name="status" lay-filter="statusFilter">
                                        <option value="">全部状态</option>
                                        <option value="pending">待审核</option>
                                        <option value="approved">已通过</option>
                                        <option value="rejected">已驳回</option>
                                        <option value="draft">草稿</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">学校</label>
                                <div class="layui-input-inline">
                                    <select name="school_id">
                                        <option value="">全部学校</option>
                                        {volist name="schools" id="school"}
                                        <option value="{$school.id}">{$school.name}</option>
                                        {/volist}
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn" lay-submit lay-filter="search">
                                    <i class="layui-icon">&#xe615;</i> 搜索
                                </button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>
                        </div>
                    </form>

                    <!-- 批量操作 -->
                    <div class="layui-form-item" style="margin-bottom: 10px;">
                        <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="batchDelete()">
                                <i class="layui-icon">&#xe640;</i> 批量删除
                            </button>
                            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="batchApprove()">
                                <i class="layui-icon">&#xe605;</i> 批量通过
                            </button>
                            <button class="layui-btn layui-btn-sm layui-btn-warm" onclick="batchReject()">
                                <i class="layui-icon">&#xe69c;</i> 批量驳回
                            </button>
                        </div>
                    </div>

                    <!-- 数据表格 -->
                    <table id="contentTable" lay-filter="contentTable"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 表格操作列模板 -->
<script type="text/html" id="operationTpl">
    <div class="layui-btn-group">
        <button class="layui-btn layui-btn-xs" lay-event="view">
            <i class="layui-icon">&#xe63c;</i> 查看
        </button>

        {{# if(d.status === 'pending'){ }}
        <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="approve">
            <i class="layui-icon">&#xe605;</i> 通过
        </button>
        <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="reject">
            <i class="layui-icon">&#xe69c;</i> 驳回
        </button>
        {{# } }}
        <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">
            <i class="layui-icon">&#xe640;</i> 删除
        </button>
    </div>
</script>

<!-- 状态模板 -->
<script type="text/html" id="statusTpl">
    {{# if(d.status === 'draft'){ }}
        <span class="layui-badge layui-bg-gray">草稿</span>
    {{# } else if(d.status === 'pending'){ }}
        <span class="layui-badge layui-bg-orange">待审核</span>
    {{# } else if(d.status === 'approved'){ }}
        <span class="layui-badge layui-bg-green">已通过</span>
    {{# } else if(d.status === 'rejected'){ }}
        <span class="layui-badge layui-bg-red">已驳回</span>
    {{# } }}
</script>

<!-- 文件类型模板 -->
<script type="text/html" id="fileTypeTpl">
    {{# if(d.file_type === 'text'){ }}
        <span class="layui-badge layui-bg-blue">文本</span>
    {{# } else if(d.file_type === 'document'){ }}
        <span class="layui-badge layui-bg-green">文档</span>
    {{# } else if(d.file_type === 'image'){ }}
        <span class="layui-badge layui-bg-orange">图片</span>
    {{# } else if(d.file_type === 'video'){ }}
        <span class="layui-badge layui-bg-red">视频</span>
    {{# } }}
</script>

<!-- 来源类型模板 -->
<script type="text/html" id="sourceTypeTpl">
    {{# if(d.source_type === 'upload'){ }}
        <span class="layui-badge layui-bg-blue">文件上传</span>
    {{# } else if(d.source_type === 'ai_generate'){ }}
        <span class="layui-badge layui-bg-purple">AI生成</span>
    {{# } }}
</script>

<!-- 课程模板 -->
<script type="text/html" id="courseTpl">
    {{# if(d.course_name && d.course_name !== '-'){ }}
        <span class="layui-badge layui-bg-green">{{d.course_name}}</span>
    {{# } else { }}
        <span class="layui-text-color">未关联</span>
    {{# } }}
</script>

<!-- 文件列表模板 -->
<script type="text/html" id="fileListTpl">
    {{# if(d.file_list && d.file_list.length > 0){ }}
        <ul style="padding-left: 10px; list-style: none;">
        {{# layui.each(d.file_list, function(index, file){ }}
            <li style="margin-bottom: 5px;">
                <a href="javascript:;" onclick="downloadFile({{file.id}}, '{{file.file_name}}')" style="color: #1E9FFF;">
                    <i class="layui-icon layui-icon-download-circle"></i> {{file.file_name}}
                </a>
                <span style="color:#888;font-size:12px;">({{file.file_size_text}})</span>
            </li>
        {{# }); }}
        </ul>
    {{# }else{ }}
        <span style="color:#aaa;">无</span>
    {{# } }}
</script>

{/block}

{block name="script"}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 渲染表格
    var tableIns = table.render({
        elem: '#contentTable',
        url: '/admin/content_library/index',
        page: true,
        cols: [[
            {type: 'checkbox', fixed: 'left'},
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'name', title: '内容名称', width: 200},
            {field: 'course_name', title: '关联课程', width: 150, templet: '#courseTpl'},
            {field: 'file_list', title: '文件列表', width: 250, templet: '#fileListTpl'},
            {field: 'source_type', title: '来源类型', width: 120, templet: '#sourceTypeTpl'},
            {field: 'status', title: '状态', width: 100, templet: '#statusTpl'},
            {field: 'creator_name', title: '创建者', width: 100},
            {field: 'school_name', title: '学校', width: 150},
            {field: 'college_name', title: '学院', width: 150},
            {field: 'create_time_text', title: '创建时间', width: 160},
            {title: '操作', width: 200, fixed: 'right', toolbar: '#operationTpl'}
        ]],
        limits: [10, 20, 50, 100],
        limit: 20,
        height: 'full-220'
    });
    
    // 搜索表单提交
    form.on('submit(search)', function(data){
        tableIns.reload({
            where: data.field,
            page: {curr: 1}
        });
        return false;
    });
    
    // 表格行工具事件
    table.on('tool(contentTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'view'){
            viewContent(data.id);
        } else if(obj.event === 'delete'){
            deleteContent(data.id);
        } else if(obj.event === 'approve'){
            approveContent(data.id);
        } else if(obj.event === 'reject'){
            rejectContent(data.id);
        }
    });
    
    // 内容审核页面
    window.auditPage = function(){
        layer.open({
            type: 2,
            title: '内容审核',
            shadeClose: true,
            shade: 0.8,
            area: ['1200px', '800px'],
            content: '/admin/content_library/audit'
        });
    };
    
    // 查看内容
    window.viewContent = function(id){
        layer.open({
            type: 2,
            title: '内容详情',
            shadeClose: true,
            shade: 0.8,
            area: ['900px', '700px'],
            content: '/admin/content_library/view?id=' + id
        });
    };
    
    // 删除内容
    window.deleteContent = function(id){
        layer.confirm('确定要删除这个内容吗？', function(index){
            $.post('/admin/content_library/delete', {id: id}, function(res){
                if(res.code === 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 审核通过
    window.approveContent = function(id){
        layer.prompt({
            title: '请输入审核备注（可选）',
            formType: 2
        }, function(remark, index){
            $.post('/admin/content_library/auditAction', {
                id: id,
                action: 'approve',
                remark: remark
            }, function(res){
                if(res.code === 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 审核驳回
    window.rejectContent = function(id){
        layer.prompt({
            title: '请输入驳回原因',
            formType: 2
        }, function(remark, index){
            $.post('/admin/content_library/auditAction', {
                id: id,
                action: 'reject',
                remark: remark
            }, function(res){
                if(res.code === 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 批量删除
    window.batchDelete = function(){
        var checkStatus = table.checkStatus('contentTable');
        if(checkStatus.data.length === 0){
            layer.msg('请选择要删除的内容', {icon: 2});
            return;
        }
        
        layer.confirm('确定要删除选中的内容吗？', function(index){
            var ids = [];
            checkStatus.data.forEach(function(item){
                ids.push(item.id);
            });
            
            $.post('/admin/content_library/batch', {
                action: 'delete',
                ids: ids
            }, function(res){
                if(res.code === 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 批量通过
    window.batchApprove = function(){
        var checkStatus = table.checkStatus('contentTable');
        if(checkStatus.data.length === 0){
            layer.msg('请选择要审核的内容', {icon: 2});
            return;
        }
        
        var ids = [];
        checkStatus.data.forEach(function(item){
            if(item.status === 'pending'){
                ids.push(item.id);
            }
        });
        
        if(ids.length === 0){
            layer.msg('选中的内容中没有待审核的内容', {icon: 2});
            return;
        }
        
        layer.confirm('确定要批量通过选中的内容吗？', function(index){
            $.post('/admin/content_library/batch', {
                action: 'approve',
                ids: ids
            }, function(res){
                if(res.code === 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 批量驳回
    window.batchReject = function(){
        var checkStatus = table.checkStatus('contentTable');
        if(checkStatus.data.length === 0){
            layer.msg('请选择要审核的内容', {icon: 2});
            return;
        }
        
        var ids = [];
        checkStatus.data.forEach(function(item){
            if(item.status === 'pending'){
                ids.push(item.id);
            }
        });
        
        if(ids.length === 0){
            layer.msg('选中的内容中没有待审核的内容', {icon: 2});
            return;
        }
        
        layer.prompt({
            title: '请输入驳回原因',
            formType: 2
        }, function(remark, index){
            $.post('/admin/content_library/batch', {
                action: 'reject',
                ids: ids,
                remark: remark
            }, function(res){
                if(res.code === 0){
                    layer.msg(res.msg, {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 统计分析
    window.statistics = function(){
        layer.open({
            type: 2,
            title: '内容库统计分析',
            shadeClose: true,
            shade: 0.8,
            area: ['1000px', '700px'],
            content: '{:url("admin/ContentLibrary/statistics")}'
        });
    };
    
    // 下载文件（与文件管理统一）
    window.downloadFile = function(id, fileName){
        window.open('/admin/file/download?id=' + id);
    };
});
</script>
{/block}
 