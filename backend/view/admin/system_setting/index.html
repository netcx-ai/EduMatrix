{extend name="common/base" /}

{block name="content"}
<style>
/* 系统设置页面样式修正 */
.system-setting-page .layui-form-label {
    width: 140px;
    text-align: right;
    padding: 9px 15px;
    font-weight: 500;
}

.system-setting-page .layui-input-block {
    margin-left: 170px;
    min-height: 36px;
}

.system-setting-page .layui-form-item {
    margin-bottom: 20px;
}

.system-setting-page .layui-input,
.system-setting-page .layui-textarea,
.system-setting-page .layui-select {
    width: 100%;
    max-width: 500px;
}

.system-setting-page .layui-textarea {
    min-height: 80px;
}

.system-setting-page .layui-form-mid {
    margin-top: 5px;
    color: #999;
    font-size: 12px;
}

.system-setting-page .layui-upload {
    margin-bottom: 10px;
}

.system-setting-page .layui-upload-list {
    margin-top: 10px;
}

.system-setting-page .layui-upload-img {
    border: 1px solid #e6e6e6;
    border-radius: 2px;
}

/* 开关样式修正 */
.system-setting-page .layui-form-radio {
    margin-right: 20px;
}

/* 卡片内容区域padding */
.system-setting-page .layui-card-body {
    padding: 20px;
}

/* 标签页内容区域 */
.system-setting-page .layui-tab-content {
    padding: 20px 0;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .system-setting-page .layui-form-label {
        width: 100px;
    }
    .system-setting-page .layui-input-block {
        margin-left: 130px;
    }
}
</style>

<div class="layui-card system-setting-page">
    <div class="layui-card-header">
        <div class="layui-row">
            <div class="layui-col-md6">
                <span class="layui-breadcrumb">
                    <a href="/admin/index/index">首页</a>
                    <a><cite>系统设置</cite></a>
                </span>
            </div>
            <div class="layui-col-md6 text-right">
                <a href="/admin/system_setting/add" class="layui-btn layui-btn-normal">
                    <i class="layui-icon">&#xe654;</i> 添加配置
                </a>
                <a href="/admin/system_setting/export" class="layui-btn layui-btn-warm">
                    <i class="layui-icon">&#xe67d;</i> 导出配置
                </a>
                <a href="/admin/system_setting/import" class="layui-btn layui-btn-primary">
                    <i class="layui-icon">&#xe67c;</i> 导入配置
                </a>
            </div>
        </div>
    </div>
    <div class="layui-card-body">
        <div class="layui-tab">
            <ul class="layui-tab-title">
                {foreach $groups as $key => $title}
                <li class="{$group==$key?'layui-this':''}">
                    <a href="/admin/system_setting/index?group={$key}">{$title}</a>
                </li>
                {/foreach}
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <form class="layui-form" action="/admin/system_setting/save" method="post">
                        <input type="hidden" name="group" value="{$group}">
                        
                        {foreach $settings as $setting}
                        <div class="layui-form-item">
                            <label class="layui-form-label">{$setting.title}</label>
                            <div class="layui-input-block">
                                {if $setting.type == 'text'}
                                    <input type="text" name="{$setting.key}" value="{$setting.value}" placeholder="请输入{$setting.title}" class="layui-input">
                                {elseif $setting.type == 'textarea'}
                                    <textarea name="{$setting.key}" placeholder="请输入{$setting.title}" class="layui-textarea">{$setting.value}</textarea>
                                {elseif $setting.type == 'number'}
                                    <input type="number" name="{$setting.key}" value="{$setting.value}" placeholder="请输入{$setting.title}" class="layui-input">
                                {elseif $setting.type == 'select'}
                                    <select name="{$setting.key}" class="layui-select">
                                        {if $setting.key == 'site_timezone'}
                                            <option value="Asia/Shanghai" {if $setting.value=='Asia/Shanghai'}selected{/if}>Asia/Shanghai</option>
                                            <option value="Asia/Beijing" {if $setting.value=='Asia/Beijing'}selected{/if}>Asia/Beijing</option>
                                            <option value="UTC" {if $setting.value=='UTC'}selected{/if}>UTC</option>
                                        {elseif $setting.key == 'site_language'}
                                            <option value="zh-cn" {if $setting.value=='zh-cn'}selected{/if}>简体中文</option>
                                            <option value="en-us" {if $setting.value=='en-us'}selected{/if}>English</option>
                                        {elseif $setting.key == 'currency'}
                                            <option value="CNY" {if $setting.value=='CNY'}selected{/if}>人民币 (CNY)</option>
                                            <option value="USD" {if $setting.value=='USD'}selected{/if}>美元 (USD)</option>
                                            <option value="EUR" {if $setting.value=='EUR'}selected{/if}>欧元 (EUR)</option>
                                        {elseif $setting.key == 'smtp_encryption'}
                                            <option value="ssl" {if $setting.value=='ssl'}selected{/if}>SSL</option>
                                            <option value="tls" {if $setting.value=='tls'}selected{/if}>TLS</option>
                                            <option value="" {if $setting.value==''}selected{/if}>无</option>
                                        {elseif $setting.key == 'cache_driver'}
                                            <option value="file" {if $setting.value=='file'}selected{/if}>文件缓存</option>
                                            <option value="redis" {if $setting.value=='redis'}selected{/if}>Redis缓存</option>
                                            <option value="memcache" {if $setting.value=='memcache'}selected{/if}>Memcache缓存</option>
                                        {elseif $setting.key == 'storage_driver'}
                                            <option value="local" {if $setting.value=='local'}selected{/if}>本地存储</option>
                                            <option value="oss" {if $setting.value=='oss'}selected{/if}>阿里云OSS</option>
                                            <option value="cos" {if $setting.value=='cos'}selected{/if}>腾讯云COS</option>
                                        {else}
                                            <!-- 如果没有预定义的选项，尝试从options字段获取 -->
                                            {if isset($setting.options) && is_array($setting.options)}
                                                {foreach $setting.options as $option_value => $option_label}
                                                    <option value="{$option_value}" {if $setting.value==$option_value}selected{/if}>{$option_label}</option>
                                                {/foreach}
                                            {/if}
                                        {/if}
                                    </select>
                                {elseif $setting.type == 'switch'}
                                    <input type="checkbox" name="{$setting.key}" value="1" lay-skin="switch" lay-text="启用|禁用" lay-filter="{$setting.key}" {if $setting.value=='1'}checked{/if}>
                                    <input type="hidden" name="{$setting.key}_value" value="{$setting.value}">
                                {elseif $setting.type == 'image'}
                                    <div class="layui-upload">
                                        <button type="button" class="layui-btn" id="upload_{$setting.key}">上传图片</button>
                                        <div class="layui-upload-list">
                                            <img class="layui-upload-img" id="preview_{$setting.key}" src="{$setting.value}" style="max-width: 200px;">
                                            <input type="hidden" name="{$setting.key}" value="{$setting.value}" id="input_{$setting.key}">
                                        </div>
                                    </div>
                                {else}
                                    <input type="text" name="{$setting.key}" value="{$setting.value}" placeholder="请输入{$setting.title}" class="layui-input">
                                {/if}
                                
                                {if $setting.description}
                                <div class="layui-form-mid layui-word-aux">{$setting.description}</div>
                                {/if}
                            </div>
                        </div>
                        {/foreach}
                        
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn" lay-submit lay-filter="saveSettings">保存设置</button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script>
layui.use(['form', 'upload', 'layer'], function(){
    var form = layui.form;
    var upload = layui.upload;
    var layer = layui.layer;
    
    // 监听switch开关
    form.on('switch', function(data){
        var name = data.elem.name;
        var value = data.elem.checked ? '1' : '0';
        // 更新隐藏字段的值
        $('input[name="' + name + '"]').val(value);
    });
    
    // 表单提交
    form.on('submit(saveSettings)', function(data){
        // 处理switch类型的值
        $('input[lay-skin="switch"]').each(function(){
            var name = $(this).attr('name');
            var checked = $(this).prop('checked');
            data.field[name] = checked ? '1' : '0';
        });
        
        $.post(data.form.action, data.field, function(res){
            if(res.code == 1){
                layer.msg(res.msg, {icon: 1});
            }else{
                layer.msg(res.msg, {icon: 2});
            }
        });
        return false;
    });
    
    // 图片上传
    $('[id^=upload_]').each(function(){
        var key = $(this).attr('id').replace('upload_', '');
        upload.render({
            elem: '#upload_' + key,
            url: '/admin/upload/image',
            done: function(res){
                if(res.code == 1){
                    $('#preview_' + key).attr('src', res.data.url);
                    $('#input_' + key).val(res.data.url);
                    layer.msg('上传成功', {icon: 1});
                }else{
                    layer.msg(res.msg, {icon: 2});
                }
            }
        });
    });
});
</script>
{/block} 