<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>职称详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="/static/layui/css/layui.css" media="all">
    <style>
        body {
            padding: 20px;
            background-color: #fff;
        }
        .info-table td {
            padding: 12px 15px;
        }
        .info-table td:first-child {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #333;
        }
        .teacher-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .teacher-item:last-child {
            border-bottom: none;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .stat-number {
            font-size: 24px;
            color: #1E9FFF;
            font-weight: bold;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="layui-row layui-col-space15">
    <div class="layui-col-md7">
        <fieldset class="layui-elem-field">
            <legend>基本信息</legend>
            <div class="layui-field-box">
                <table class="layui-table info-table" lay-skin="line">
                    <colgroup>
                        <col width="120">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <td>职称名称</td>
                            <td>
                                <span class="layui-badge layui-bg-blue" style="font-size: 14px; padding: 5px 10px;">
                                    {$title.name}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>职称代码</td>
                            <td>
                                <code style="background: #f2f2f2; padding: 2px 6px; border-radius: 3px;">
                                    {$title.code}
                                </code>
                            </td>
                        </tr>
                        <tr>
                            <td>职称级别</td>
                            <td>
                                {php}$levelDesc = \app\model\TeacherTitle::getLevelDescription($title['level']);{/php}
                                <span class="layui-badge" style="background-color: {if $title.level == 5}#FF5722{elseif $title.level == 4}#FFB800{elseif $title.level == 3}#01AAED{elseif $title.level == 2}#5FB878{else}#c2c2c2{/if};">{$levelDesc}</span>
                            </td>
                        </tr>
                        <tr>
                            <td>排序</td>
                            <td>{$title.sort}</td>
                        </tr>
                        <tr>
                            <td>状态</td>
                            <td>
                                {if $title.status == 1}
                                    <span class="layui-badge layui-bg-green" id="statusBadge">启用</span>
                                {else}
                                    <span class="layui-badge layui-bg-danger" id="statusBadge">禁用</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>描述</td>
                            <td>{$title.description|default='暂无描述'}</td>
                        </tr>
                        <tr>
                            <td>创建时间</td>
                            <td>{$title.create_time}</td>
                        </tr>
                        <tr>
                            <td>更新时间</td>
                            <td>{$title.update_time|default='未更新'}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </fieldset>
    </div>
    
    <div class="layui-col-md5">
        <fieldset class="layui-elem-field">
            <legend>使用统计</legend>
            <div class="layui-field-box">
                <div class="stat-box">
                    <div class="stat-number">{$teacherCount|default='0'}</div>
                    <div class="stat-label">使用该职称的教师数量</div>
                </div>
                
                <div class="layui-progress" lay-showpercent="true">
                    <div class="layui-progress-bar" lay-percent="{$usagePercent|default='0'}%"></div>
                </div>
                <div class="layui-word-aux" style="text-align: center; margin-top: 5px;">
                    占所有教师的 {$usagePercent|default='0'}%
                </div>
                
                <hr class="layui-border-gray" style="margin: 20px 0;">
                
                <div class="layui-btn-container" style="text-align: center;">
                    <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="editTitle({$title.id})">
                        <i class="layui-icon layui-icon-edit"></i> 编辑
                    </button>
                    <button class="layui-btn layui-btn-sm {if $title.status == 1}layui-btn-danger{else}layui-btn-normal{/if}" id="statusBtn_{$title.id}" data-id="{$title.id}" data-status="{if $title.status == 1}0{else}1{/if}">
                        <i class="layui-icon {if $title.status == 1}layui-icon-pause{else}layui-icon-play{/if}"></i> 
                        <span id="statusText_{$title.id}">{if $title.status == 1}禁用{else}启用{/if}</span>
                    </button>
                    <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="deleteTitle({$title.id})">
                        <i class="layui-icon layui-icon-delete"></i> 删除
                    </button>
                </div>
            </div>
        </fieldset>
    </div>
</div>

{if $teachers}
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>使用该职称的教师（最新10位）</legend>
</fieldset>

<table class="layui-table">
    <thead>
        <tr>
            <th>教师姓名</th>
            <th>工号</th>
            <th>所属学校</th>
            <th>所属学院</th>
            <th>状态</th>
            <th>入职日期</th>
        </tr>
    </thead>
    <tbody>
        {foreach $teachers as $teacher}
        <tr>
            <td>{$teacher.name}</td>
            <td>{$teacher.teacher_no}</td>
            <td>{$teacher.school_name}</td>
            <td>{$teacher.college_name}</td>
            <td>
                {if $teacher.status == 1}
                    <span class="layui-badge layui-bg-green">在职</span>
                {else}
                    <span class="layui-badge layui-bg-gray">离职</span>
                {/if}
            </td>
            <td>{$teacher.join_date|default='未知'}</td>
        </tr>
        {/foreach}
    </tbody>
</table>
{else}
<div style="text-align: center; padding: 40px; color: #999;">
    <i class="layui-icon layui-icon-user" style="font-size: 48px;"></i>
    <p>暂无教师使用该职称</p>
</div>
{/if}

<script src="/static/admin/js/jquery-3.7.1.min.js"></script>
<script src="/static/layui/layui.js"></script>
<script>
layui.use(['layer', 'element'], function(){
    var layer = layui.layer;
    var element = layui.element;
    var $ = layui.$;
    
    // 更新进度条
    element.render('progress');
    
    // 绑定状态按钮点击事件
    $('#statusBtn_{$title.id}').on('click', function() {
        var id = $(this).data('id');
        var status = $(this).data('status');
        changeStatus(id, status);
    });
    
    // 编辑职称
    window.editTitle = function(id) {
        parent.layer.open({
            type: 2,
            title: '编辑职称',
            shadeClose: true,
            shade: 0.8,
            area: ['600px', '500px'],
            content: '/admin/teacher_title/edit?id=' + id + '&popup=1',
            end: function(){
                // 刷新当前弹窗
                location.reload();
                // 刷新父页面表格
                parent.layui.table.reload('titleTable');
            }
        });
    };
    
    // 改变状态
    window.changeStatus = function(id, status) {
        var text = status ? '启用' : '禁用';
        
        layer.confirm('确定' + text + '该职称吗？', function(index){
            $.post('/admin/teacher_title/changeStatus', {
                id: id,
                status: status
            }, function(res){
                if(res.code === 0){
                    layer.close(index);
                    layer.msg(text + '成功', {icon: 1, time: 1000}, function(){
                        // 动态更新按钮文字和状态
                        var $statusBtn = $('#statusBtn_' + id);
                        var $statusText = $('#statusText_' + id);
                        var $statusIcon = $statusBtn.find('i');
                        
                        if (status == 1) {
                            // 启用状态
                            $statusBtn[0].className = 'layui-btn layui-btn-sm layui-btn-normal';
                            $statusIcon[0].className = 'layui-icon layui-icon-play';
                            $statusText.text('启用');
                            $statusBtn.data('status', 0);
                        } else {
                            // 禁用状态
                            $statusBtn[0].className = 'layui-btn layui-btn-sm layui-btn-danger';
                            $statusIcon[0].className = 'layui-icon layui-icon-pause';
                            $statusText.text('禁用');
                            $statusBtn.data('status', 1);
                        }
                        
                        // 更新状态显示
                        var $statusBadge = $('#statusBadge');
                        if (status == 1) {
                            $statusBadge.removeClass('layui-bg-danger').addClass('layui-bg-green').text('启用');
                        } else {
                            $statusBadge.removeClass('layui-bg-green').addClass('layui-bg-danger').text('禁用');
                        }
                        
                        // 重新加载当前弹窗，让模板重新渲染
                        setTimeout(function() {
                            location.reload();
                        }, 500);
                        
                        // 刷新父页面表格，确保数据同步
                        if (parent.layui && parent.layui.table) {
                            parent.layui.table.reloadData('titleTable');
                        }
                    });
                } else {
                    layer.msg(res.msg || text + '失败', {icon: 2});
                }
            });
        });
    };
    
    // 删除职称
    window.deleteTitle = function(id) {
        layer.confirm('确定删除该职称吗？删除后无法恢复！', {
            icon: 3,
            title: '确认删除'
        }, function(index){
            $.post('/admin/teacher_title/destroy/' + id, function(res){
                if(res.code === 0){
                    layer.close(index);
                    layer.msg('删除成功', {icon: 1, time: 1000}, function(){
                        parent.layer.closeAll();
                        parent.layui.table.reload('titleTable');
                    });
                } else {
                    layer.msg(res.msg || '删除失败', {icon: 2});
                }
            });
        });
    };
});
</script>
</body>
</html> 