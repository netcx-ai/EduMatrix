{extend name="common/base" /}

{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">
        <div class="layui-row">
            <div class="layui-col-md6">
                <span class="layui-breadcrumb">
                    <a href="/admin/index/index">首页</a>
                    <a href="/admin/user/index">会员管理</a>
                    <a><cite>积分管理</cite></a>
                </span>
            </div>
        </div>
    </div>
    <div class="layui-card-body">
        <!-- 搜索栏 -->
        <div class="layui-form layui-form-pane" style="margin-bottom: 15px;">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">关键词</label>
                    <div class="layui-input-inline">
                        <input type="text" name="keyword" placeholder="用户名/姓名/手机/邮箱" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn" lay-submit lay-filter="search">
                        <i class="layui-icon">&#xe615;</i> 搜索
                    </button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <table id="pointsTable" lay-filter="pointsTable"></table>
    </div>
</div>

<!-- 操作按钮模板 -->
<script type="text/html" id="operationBar">
    <a class="layui-btn layui-btn-xs" lay-event="add">增加积分</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="deduct">扣除积分</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">查看详情</a>
</script>

<!-- 积分模板 -->
<script type="text/html" id="pointsTpl">
    <span class="layui-badge layui-bg-orange">{{ d.points }}</span>
</script>

<!-- 调整积分弹窗模板 -->
<script type="text/html" id="adjustPointsTpl">
    <form class="layui-form" style="padding: 20px;">
        <input type="hidden" name="id" value="{{ d.id }}">
        <div class="layui-form-item">
            <label class="layui-form-label">当前积分</label>
            <div class="layui-input-block">
                <input type="text" value="{{ d.points }}" class="layui-input" readonly>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">操作类型</label>
            <div class="layui-input-block">
                <input type="radio" name="type" value="add" title="增加积分" checked>
                <input type="radio" name="type" value="deduct" title="扣除积分">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">积分数量</label>
            <div class="layui-input-block">
                <input type="number" name="points" placeholder="请输入积分数量" class="layui-input" min="1" required>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">调整原因</label>
            <div class="layui-input-block">
                <textarea name="reason" placeholder="请输入调整原因" class="layui-textarea"></textarea>
            </div>
        </div>
    </form>
</script>
{/block}

{block name="script"}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 渲染表格
    var tableIns = table.render({
        elem: '#pointsTable',
        url: '/admin/user/points',
        page: true,
        cols: [[
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'username', title: '用户名'},
            {field: 'real_name', title: '真实姓名'},
            {field: 'phone', title: '手机号'},
            {field: 'email', title: '邮箱'},
            {field: 'points', title: '积分', templet: '#pointsTpl', sort: true},
            {field: 'member_level', title: '会员等级'},
            {field: 'create_time', title: '注册时间'},
            {title: '操作', toolbar: '#operationBar', fixed: 'right'}
        ]],
        limits: [10, 20, 50, 100],
        limit: 10
    });
    
    // 搜索
    form.on('submit(search)', function(data){
        tableIns.reload({
            where: data.field,
            page: {curr: 1}
        });
        return false;
    });
    
    // 监听工具条
    table.on('tool(pointsTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'add' || obj.event === 'deduct'){
            var title = obj.event === 'add' ? '增加积分' : '扣除积分';
            layer.open({
                type: 1,
                title: title,
                shadeClose: true,
                shade: 0.8,
                area: ['500px', '400px'],
                content: laytpl($('#adjustPointsTpl').html()).render(data),
                btn: ['确定', '取消'],
                yes: function(index, layero){
                    var formData = form.val('adjustPointsForm');
                    $.post('/admin/user/adjustPoints', formData, function(res){
                        if(res.code == 0){
                            layer.msg(res.msg, {icon: 1});
                            tableIns.reload();
                            layer.close(index);
                        }else{
                            layer.msg(res.msg, {icon: 2});
                        }
                    });
                }
            });
            form.render();
        } else if(obj.event === 'view'){
            layer.open({
                type: 2,
                title: '会员详情',
                shadeClose: true,
                shade: 0.8,
                area: ['800px', '600px'],
                content: '/admin/user/edit?id=' + data.id
            });
        }
    });
});
</script>
{/block} 