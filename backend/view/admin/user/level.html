{extend name="common/base" /}

{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">
        <div class="layui-row">
            <div class="layui-col-md6">
                <span class="layui-breadcrumb">
                    <a href="/admin/index/index">首页</a>
                    <a href="/admin/user/index">会员管理</a>
                    <a><cite>会员等级</cite></a>
                </span>
            </div>
        </div>
    </div>
    <div class="layui-card-body">
        <!-- 搜索栏 -->
        <div class="layui-form layui-form-pane" style="margin-bottom: 15px;">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">会员等级</label>
                    <div class="layui-input-inline">
                        <select name="level">
                            <option value="">全部等级</option>
                            <option value="1">普通会员</option>
                            <option value="2">VIP会员</option>
                            <option value="3">SVIP会员</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn" lay-submit lay-filter="search">
                        <i class="layui-icon">&#xe615;</i> 搜索
                    </button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <table id="levelTable" lay-filter="levelTable"></table>
    </div>
</div>

<!-- 操作按钮模板 -->
<script type="text/html" id="operationBar">
    <a class="layui-btn layui-btn-xs" lay-event="adjust">调整等级</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">查看详情</a>
</script>

<!-- 会员等级模板 -->
<script type="text/html" id="levelTpl">
    {{# if(d.member_level == 1) { }}
    <span class="layui-badge layui-bg-gray">普通会员</span>
    {{# } else if(d.member_level == 2) { }}
    <span class="layui-badge layui-bg-blue">VIP会员</span>
    {{# } else if(d.member_level == 3) { }}
    <span class="layui-badge layui-bg-orange">SVIP会员</span>
    {{# } else { }}
    <span class="layui-badge">未知</span>
    {{# } }}
</script>

<!-- 到期状态模板 -->
<script type="text/html" id="expireTpl">
    {{# if(d.member_expire_time) { }}
        {{# if(d.is_expired) { }}
        <span class="layui-badge layui-bg-red">已过期</span>
        {{# } else { }}
        <span class="layui-badge layui-bg-green">有效</span>
        <br><small>剩余 {{ d.remaining_days }} 天</small>
        {{# } }}
    {{# } else { }}
    <span class="layui-badge layui-bg-green">永久</span>
    {{# } }}
</script>

<!-- 调整等级弹窗模板 -->
<script type="text/html" id="adjustLevelTpl">
    <form class="layui-form" style="padding: 20px;">
        <input type="hidden" name="id" value="{{ d.id }}">
        <div class="layui-form-item">
            <label class="layui-form-label">当前等级</label>
            <div class="layui-input-block">
                <input type="text" value="{{ d.member_level_text }}" class="layui-input" readonly>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">新等级</label>
            <div class="layui-input-block">
                <select name="level" lay-verify="required">
                    <option value="">请选择等级</option>
                    <option value="1">普通会员</option>
                    <option value="2">VIP会员</option>
                    <option value="3">SVIP会员</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">有效期</label>
            <div class="layui-input-block">
                <input type="number" name="days" placeholder="天数，0为永久" class="layui-input" min="0">
            </div>
        </div>
    </form>
</script>
{/block}

{block name="script"}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 渲染表格
    var tableIns = table.render({
        elem: '#levelTable',
        url: '/admin/user/level',
        page: true,
        cols: [[
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'username', title: '用户名'},
            {field: 'real_name', title: '真实姓名'},
            {field: 'member_level', title: '会员等级', templet: '#levelTpl'},
            {field: 'member_expire_time', title: '到期时间'},
            {field: 'is_expired', title: '状态', templet: '#expireTpl'},
            {field: 'points', title: '积分', sort: true},
            {field: 'create_time', title: '注册时间'},
            {title: '操作', toolbar: '#operationBar', fixed: 'right'}
        ]],
        limits: [10, 20, 50, 100],
        limit: 10
    });
    
    // 搜索
    form.on('submit(search)', function(data){
        tableIns.reload({
            where: data.field,
            page: {curr: 1}
        });
        return false;
    });
    
    // 监听工具条
    table.on('tool(levelTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'adjust'){
            layer.open({
                type: 1,
                title: '调整会员等级',
                shadeClose: true,
                shade: 0.8,
                area: ['500px', '300px'],
                content: laytpl($('#adjustLevelTpl').html()).render(data),
                btn: ['确定', '取消'],
                yes: function(index, layero){
                    var formData = form.val('adjustLevelForm');
                    $.post('/admin/user/adjustLevel', formData, function(res){
                        if(res.code == 0){
                            layer.msg(res.msg, {icon: 1});
                            tableIns.reload();
                            layer.close(index);
                        }else{
                            layer.msg(res.msg, {icon: 2});
                        }
                    });
                }
            });
            form.render();
        } else if(obj.event === 'view'){
            layer.open({
                type: 2,
                title: '会员详情',
                shadeClose: true,
                shade: 0.8,
                area: ['800px', '600px'],
                content: '/admin/user/edit?id=' + data.id
            });
        }
    });
});
</script>
{/block} 