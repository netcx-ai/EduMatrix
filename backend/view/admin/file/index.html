{extend name="common/base" /}

{block name="content"}
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">
            <div class="layui-row">
                <div class="layui-col-md6">
                    <span class="layui-badge layui-bg-blue">文件管理</span>
                </div>
            </div>
        </div>
        <div class="layui-card-body">
            <!-- 搜索栏 -->
            <form class="layui-form layui-form-pane" lay-filter="searchForm" style="margin-bottom: 15px;">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">文件名</label>
                        <div class="layui-input-inline">
                            <input type="text" name="keyword" placeholder="请输入文件名" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">文件类型</label>
                        <div class="layui-input-inline">
                            <select name="category">
                                <option value="">全部类型</option>
                                {volist name="categories" id="name" key="value"}
                                <option value="{$value}">{$name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">学校</label>
                        <div class="layui-input-inline">
                            <select name="school_id">
                                <option value="">全部学校</option>
                                {volist name="schools" id="school"}
                                <option value="{$school.id}">{$school.name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn" lay-submit lay-filter="search">
                            <i class="layui-icon layui-icon-search"></i> 搜索
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>

            <!-- 批量操作 -->
            <div class="layui-form-item" style="margin-bottom: 10px;">
                <div class="layui-btn-group">
                    <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="batchDelete()">
                        <i class="layui-icon">&#xe640;</i> 批量删除
                    </button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="batchDownload()">
                        <i class="layui-icon">&#xe601;</i> 批量下载
                    </button>
                </div>
            </div>

            <!-- 数据表格 -->
            <table id="fileTable" lay-filter="fileTable"></table>
        </div>
    </div>
</div>

<!-- 表格操作按钮 -->
<script type="text/html" id="operationTpl">
    <div class="layui-btn-group">
        <button class="layui-btn layui-btn-xs" lay-event="view">
            <i class="layui-icon">&#xe63c;</i> 查看
        </button>
        <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="download">
            <i class="layui-icon">&#xe601;</i> 下载
        </button>
        <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="edit">
            <i class="layui-icon">&#xe642;</i> 编辑
        </button>
        <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">
            <i class="layui-icon">&#xe640;</i> 删除
        </button>
    </div>
</script>

<!-- 文件类型模板 -->
<script type="text/html" id="categoryTpl">
    {{# if(d.file_category === 'document'){ }}
        <span class="layui-badge layui-bg-blue">文档</span>
    {{# } else if(d.file_category === 'image'){ }}
        <span class="layui-badge layui-bg-green">图片</span>
    {{# } else if(d.file_category === 'video'){ }}
        <span class="layui-badge layui-bg-orange">视频</span>
    {{# } else if(d.file_category === 'audio'){ }}
        <span class="layui-badge layui-bg-purple">音频</span>
    {{# } else { }}
        <span class="layui-badge layui-bg-gray">其他</span>
    {{# } }}
</script>

{/block}

{block name="script"}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 渲染表格
    var tableIns = table.render({
        elem: '#fileTable',
        url: '/admin/file/index',
        page: true,
        cols: [[
            {type: 'checkbox', fixed: 'left'},
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'file_name', title: '文件名'},
            {field: 'file_category', title: '类型', templet: '#categoryTpl'},
            {field: 'file_size_text', title: '大小'},
            {field: 'uploader_name', title: '上传者'},
            {field: 'school_name', title: '学校'},
            {field: 'download_count', title: '下载次数',  align: 'center'},
            {field: 'create_time_text', title: '创建时间'},
            {title: '操作', fixed: 'right', toolbar: '#operationTpl'}
        ]],
        limits: [10, 20, 50, 100],
        limit: 20,
        height: 'full-220'
    });
    
    // 搜索表单提交
    form.on('submit(search)', function(data){
        tableIns.reload({
            where: data.field,
            page: {curr: 1}
        });
        return false;
    });
    
    // 表格行工具事件
    table.on('tool(fileTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'view'){
            viewFile(data.id);
        } else if(obj.event === 'download'){
            downloadFile(data.id);
        } else if(obj.event === 'edit'){
            editFile(data.id);
        } else if(obj.event === 'delete'){
            deleteFile(data.id);
        }
    });
    
    // 查看文件
    window.viewFile = function(id){
        layer.open({
            type: 2,
            title: '文件详情',
            shadeClose: true,
            shade: 0.8,
            area: ['900px', '700px'],
            content: '/admin/file/detail?id=' + id
        });
    };
    
    // 下载文件
    window.downloadFile = function(id){
        window.open('/admin/file/download?id=' + id);
    };
    
    // 编辑文件
    window.editFile = function(id){
        // 获取文件信息
        $.get('/admin/file/show/' + id, function(res){
            if(res.code === 0){
                var file = res.data;
                layer.prompt({
                    title: '编辑文件名',
                    value: file.file_name
                }, function(value, index){
                    $.ajax({
                        url: '/admin/file/update/' + id,
                        type: 'PUT',
                        data: {file_name: value},
                        success: function(res){
                            if(res.code === 0){
                                layer.msg('更新成功', {icon: 1});
                                tableIns.reload();
                            } else {
                                layer.msg(res.msg || '更新失败', {icon: 2});
                            }
                        }
                    });
                    layer.close(index);
                });
            }
        });
    };
    
    // 删除文件
    window.deleteFile = function(id){
        layer.confirm('确定要删除此文件吗？', function(index){
            $.ajax({
                url: '/admin/file/destroy/' + id,
                type: 'DELETE',
                success: function(res){
                    if(res.code === 0){
                        layer.msg('删除成功', {icon: 1});
                        tableIns.reload();
                    } else {
                        layer.msg(res.msg || '删除失败', {icon: 2});
                    }
                }
            });
            layer.close(index);
        });
    };
    
    // 批量删除
    window.batchDelete = function(){
        var checkStatus = table.checkStatus('fileTable');
        if(checkStatus.data.length === 0){
            layer.msg('请选择要删除的文件', {icon: 2});
            return;
        }
        
        layer.confirm('确定要删除选中的文件吗？', function(index){
            var ids = [];
            checkStatus.data.forEach(function(item){
                ids.push(item.id);
            });
            
            $.post('/admin/file/batch', {
                action: 'delete',
                ids: ids
            }, function(res){
                if(res.code === 0){
                    layer.msg('批量删除成功', {icon: 1});
                    tableIns.reload();
                } else {
                    layer.msg(res.msg || '批量删除失败', {icon: 2});
                }
            });
            layer.close(index);
        });
    };
    
    // 批量下载
    window.batchDownload = function(){
        var checkStatus = table.checkStatus('fileTable');
        if(checkStatus.data.length === 0){
            layer.msg('请选择要下载的文件', {icon: 2});
            return;
        }
        
        var ids = [];
        checkStatus.data.forEach(function(item){
            ids.push(item.id);
        });
        
        $.post('/admin/file/batch', {
            action: 'download',
            ids: ids
        }, function(res){
            if(res.code === 0){
                layer.msg('批量下载已开始', {icon: 1});
            } else {
                layer.msg(res.msg || '批量下载失败', {icon: 2});
            }
        });
    };
});
</script>
{/block} 