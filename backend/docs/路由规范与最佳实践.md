# ThinkPHP 路由规范与最佳实践

## 问题回顾

### 经典错误案例
```
错误信息：{"code":400,"message":"教师ID格式不正确"}
请求：GET /api/school/teachers/audit
```

### 错误原因
```php
// ❌ 错误的路由定义顺序
Route::resource('teachers', '\app\controller\api\school\TeacherController'); // 先定义
Route::get('teachers/audit', '\app\controller\api\school\TeacherController@pending'); // 后定义
```

**问题分析：**
- ThinkPHP 路由按定义顺序匹配
- `Route::resource('teachers', ...)` 会生成 `GET /teachers/{id}` 路由
- `/teachers/audit` 被 `{id}` 路由优先匹配，`audit` 被当作 `id` 参数
- 控制器校验 `is_numeric('audit')` 失败，返回错误

## 正确的路由定义规范

### 1. 路由定义顺序原则

```php
// ✅ 正确的路由定义顺序
Route::group('api/school', function () {
    // 1. 先定义所有自定义路由（具体路径）
    Route::get('teachers/pending', '\app\controller\api\school\TeacherController@pending');
    Route::get('teachers/audit', '\app\controller\api\school\TeacherController@pending');
    Route::post('teachers/:id/verify', '\app\controller\api\school\TeacherController@verify');
    Route::post('teachers/:id/approve', '\app\controller\api\school\TeacherController@approve');
    Route::post('teachers/:id/reject', '\app\controller\api\school\TeacherController@reject');
    Route::post('teachers/batch-verify', '\app\controller\api\school\TeacherController@batchVerify');
    Route::post('teachers/batch-audit', '\app\controller\api\school\TeacherController@batchVerify');
    Route::get('teachers/pending-count', '\app\controller\api\school\TeacherController@getPendingCount');
    
    // 2. 最后定义 RESTful 资源路由（通用路径）
    Route::resource('teachers', '\app\controller\api\school\TeacherController');
});
```

### 2. 路由优先级规则

ThinkPHP 路由匹配优先级（从高到低）：

1. **具体路径** > **参数路径**
   ```php
   Route::get('teachers/audit', ...);     // 优先匹配
   Route::get('teachers/:id', ...);       // 后匹配
   ```

2. **长路径** > **短路径**
   ```php
   Route::get('teachers/pending/count', ...);  // 优先匹配
   Route::get('teachers/pending', ...);        // 后匹配
   ```

3. **定义顺序** > **路径长度**
   ```php
   // 即使路径更长，先定义的也会优先匹配
   Route::get('teachers/:id/verify', ...);     // 先定义，优先匹配
   Route::get('teachers/pending/count', ...);  // 后定义，后匹配
   ```

## 最佳实践

### 1. 路由组织原则

```php
Route::group('api/school', function () {
    // 1. 统计类接口
    Route::get('stats', '\app\controller\api\school\StatsController@overview');
    Route::get('statistics', '\app\controller\api\school\StatsController@statistics');
    
    // 2. 自定义业务接口（具体路径）
    Route::get('college/list', '\app\controller\api\school\CollegeController@list');
    Route::get('teachers/pending', '\app\controller\api\school\TeacherController@pending');
    Route::get('teachers/audit', '\app\controller\api\school\TeacherController@pending');
    
    // 3. 带参数的接口
    Route::post('teachers/:id/verify', '\app\controller\api\school\TeacherController@verify');
    Route::post('teachers/:id/approve', '\app\controller\api\school\TeacherController@approve');
    
    // 4. RESTful 资源路由（最后定义）
    Route::resource('college', '\app\controller\api\school\CollegeController');
    Route::resource('teachers', '\app\controller\api\school\TeacherController');
    Route::resource('courses', '\app\controller\api\school\CourseController');
});
```

### 2. 路由命名规范

```php
// 使用语义化的路由名称
Route::get('teachers/pending', '\app\controller\api\school\TeacherController@pending')->name('teachers.pending');
Route::get('teachers/audit', '\app\controller\api\school\TeacherController@pending')->name('teachers.audit');
Route::post('teachers/:id/approve', '\app\controller\api\school\TeacherController@approve')->name('teachers.approve');
```

### 3. 路由参数验证

```php
// 在路由层面进行参数验证
Route::post('teachers/:id/verify', '\app\controller\api\school\TeacherController@verify')
    ->pattern(['id' => '\d+']); // 确保 id 是数字

Route::get('teachers/:id', '\app\controller\api\school\TeacherController@show')
    ->pattern(['id' => '\d+']); // 确保 id 是数字
```

### 4. 路由中间件

```php
// 为特定路由组添加中间件
Route::group('api/school', function () {
    // 需要认证的路由
    Route::group(function () {
        Route::resource('teachers', '\app\controller\api\school\TeacherController');
    })->middleware([\app\middleware\JwtAuth::class, \app\middleware\SchoolAuth::class]);
    
    // 公开路由
    Route::get('public/stats', '\app\controller\api\school\StatsController@public');
})->middleware(\app\middleware\AllowCrossDomain::class);
```

## 常见陷阱与解决方案

### 1. 路由冲突

**问题：**
```php
Route::resource('users', '\app\controller\UserController');
Route::get('users/profile', '\app\controller\UserController@profile'); // 冲突！
```

**解决：**
```php
Route::get('users/profile', '\app\controller\UserController@profile'); // 先定义
Route::resource('users', '\app\controller\UserController'); // 后定义
```

### 2. 参数路径冲突

**问题：**
```php
Route::get('users/:id', '\app\controller\UserController@show');
Route::get('users/profile', '\app\controller\UserController@profile'); // 可能被 :id 匹配
```

**解决：**
```php
Route::get('users/profile', '\app\controller\UserController@profile'); // 具体路径先定义
Route::get('users/:id', '\app\controller\UserController@show'); // 参数路径后定义
```

### 3. 路由缓存问题

**问题：** 修改路由后仍然使用旧路由

**解决：**
```bash
# 清理路由缓存
php think route:clear

# 或者重启服务
php think serve
```

## 调试技巧

### 1. 查看所有路由

```bash
# 查看所有路由
php think route:list

# 查看特定模块的路由
php think route:list | grep teachers
```

### 2. 路由测试

```bash
# 测试路由匹配
php think route:test GET /api/school/teachers/audit
```

### 3. 路由调试

```php
// 在控制器中添加调试信息
public function pending()
{
    // 打印当前路由信息
    dump($this->request->route());
    dump($this->request->pathinfo());
    
    // 业务逻辑...
}
```

## 总结

1. **自定义路由必须在 RESTful 资源路由之前定义**
2. **具体路径必须在参数路径之前定义**
3. **路由定义顺序直接影响匹配优先级**
4. **修改路由后要清理缓存**
5. **使用语义化的路由名称便于维护**

遵循这些规范，可以避免大部分路由冲突问题！ 
 