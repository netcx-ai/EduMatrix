# 用户体系升级说明

## 🎯 升级目标

修复用户注册和关联流程，建立完整的用户认证体系：

1. **修复学校管理员表结构** - 添加 `user_id` 字段
2. **完善教师用户关联** - 为每个教师创建对应的用户记录
3. **统一登录认证** - 所有用户通过 `edu_user` 表进行认证
4. **完善测试数据** - 生成完整的测试数据用于业务流程测试

## 🔧 修复内容

### 1. 数据库结构修复

#### 学校管理员表 (`edu_school_admin`)
```sql
-- 新增字段
ALTER TABLE edu_school_admin ADD COLUMN user_id INT COMMENT '关联用户ID';
ALTER TABLE edu_school_admin ADD INDEX idx_user_id (user_id);
```

#### 用户表 (`edu_user`)
- 已包含完整的用户类型支持：`member`, `teacher`, `admin`, `school_admin`
- 支持多学校关联：`primary_school_id`
- 支持教师工号：`teacher_no`

### 2. 模型关联修复

#### SchoolAdmin 模型
- 新增 `user_id` 字段到 schema
- 新增 `user()` 关联方法
- 新增 `getByUserId()` 方法
- 新增 `createWithUser()` 方法

#### User 模型
- 已包含完整的用户类型判断方法
- 支持用户类型转换
- 支持权限检查

### 3. 测试数据完善

#### 数据规模
- **5所学校**：北京大学、清华大学、复旦大学、浙江大学、南京大学
- **约18个学院**：每所学校3-4个学院
- **约90-144名教师**：每个学院5-8名教师
- **约54-90门课程**：每个学院3-5门课程
- **5名学校管理员**：每所学校1名管理员

#### 关联关系
- 每个教师都有对应的用户记录
- 每个学校管理员都有对应的用户记录
- 所有AI工具权限已分配（每日200次，每月5000次）

## 🚀 执行步骤

### 方法一：使用执行脚本（推荐）

```bash
cd backend
php run_migration_and_seed.php
```

### 方法二：手动执行

```bash
# 1. 执行数据库迁移
php think migrate:run

# 2. 执行种子数据填充
php think seed:run --seed TestDataSeeder
```

## 📊 验证结果

执行完成后，系统将包含：

### 用户数据
- **教师用户**：约90-144个，用户名格式：`teacher10001`, `teacher10002`...
- **学校管理员用户**：5个，用户名格式：`schooladmin1`, `schooladmin2`...
- **默认密码**：所有测试账号密码均为 `123456`

### 关联关系
- ✅ 教师表与用户表完全关联
- ✅ 学校管理员表与用户表完全关联
- ✅ 课程与教师正确关联
- ✅ AI工具权限完整分配

## 🔐 登录流程

### 教师登录
1. 使用教师用户名/手机号/邮箱登录
2. 系统验证 `edu_user` 表
3. 获取对应的教师信息
4. 返回教师权限和学校信息

### 学校管理员登录
1. 使用管理员用户名/手机号/邮箱登录
2. 系统验证 `edu_user` 表
3. 获取对应的学校管理员信息
4. 返回管理员权限和学校信息

## 🧪 测试建议

### 1. 基础功能测试
- [ ] 教师注册流程
- [ ] 教师登录认证
- [ ] 学校管理员登录认证
- [ ] 用户信息获取

### 2. 权限测试
- [ ] 教师只能访问自己学校的数据
- [ ] 学校管理员只能管理自己学校
- [ ] 数据隔离验证

### 3. AI工具测试
- [ ] AI工具权限验证
- [ ] 使用限制测试
- [ ] 使用记录统计

### 4. 业务流程测试
- [ ] 课程管理流程
- [ ] 教师管理流程
- [ ] 学院管理流程

## 📝 注意事项

1. **数据安全**：执行前请备份数据库
2. **密码安全**：生产环境请修改默认密码
3. **权限配置**：确保文件权限正确
4. **日志监控**：关注执行过程中的错误日志

## 🔄 回滚方案

如需回滚，可以：

1. **恢复数据库备份**
2. **删除新增的测试数据**
3. **回滚数据库迁移**

```sql
-- 删除测试数据
DELETE FROM edu_user WHERE user_type IN ('teacher', 'school_admin');
DELETE FROM edu_teacher;
DELETE FROM edu_school_admin;
DELETE FROM edu_course;
DELETE FROM edu_college;
DELETE FROM edu_school;
```

## 📞 技术支持

如遇到问题，请检查：

1. **数据库连接**：确保数据库配置正确
2. **文件权限**：确保脚本有执行权限
3. **PHP版本**：确保PHP版本兼容
4. **扩展依赖**：确保必要的PHP扩展已安装

---

**升级完成时间**：2025-01-09  
**版本**：v2.0.0  
**维护者**：EduMatrix开发团队 