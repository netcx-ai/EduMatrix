<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>媒体选择器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: transparent !important;
            color: #1a1a1a;
            line-height: 1.5;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(20px);
            margin: 10px !important;
            border-radius: 16px !important;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.12),
                0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
            overflow: hidden;
            border: none;
        }

        .header {
            background: transparent;
            color: #1a1a1a;
            padding: 20px 30px 16px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #1a1a1a;
            letter-spacing: -0.02em;
        }

        .header-info {
            font-size: 14px;
            color: rgba(26, 26, 26, 0.6);
            margin-top: 6px;
            font-weight: 400;
        }

        .toolbar {
            padding: 16px 30px;
            background: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
        }

        .toolbar-row {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
        }

        .toolbar-center.hidden {
            display: none;
        }

        .media-filter {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 4px;
            gap: 2px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .media-filter.hidden {
            display: none;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: rgba(26, 26, 26, 0.6);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: rgba(59, 130, 246, 0.08);
            color: #3b82f6;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .filter-btn.active:hover {
            background: linear-gradient(135deg, #4f8ef7 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .filter-btn svg {
            transition: all 0.2s ease;
        }

        .filter-btn:hover svg {
            transform: scale(1.1);
        }

        .filter-btn.active svg {
            transform: scale(1.05);
        }
        


        .btn-icon {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255, 255, 255, 0.8);
            color: rgba(26, 26, 26, 0.7);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a1a;
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        


        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            height: 48px;
            backdrop-filter: blur(10px);
            letter-spacing: -0.01em;
            min-width: 140px;
            justify-content: center;
        }

        /* .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        } */

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #4f8ef7 0%, #2563eb 100%);
            border: 2px solid #1d4ed8;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: rgba(26, 26, 26, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a1a;
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 2px solid #3b82f6;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 
                0 4px 16px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-size: 15px;
            padding: 16px 24px;
            height: 48px;
            min-width: 160px;
        }

        .btn-success:hover {
            box-shadow: 
                0 8px 24px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-upload {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 
                0 4px 16px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-size: 15px;
            padding: 16px 24px;
            height: 48px;
            min-width: 140px;
        }

        .btn-upload:hover {
            box-shadow: 
                0 8px 24px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .gallery-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .gallery-header {
            padding: 10px 15px 6px;
            border-bottom: 1px solid #e1e8ed;
            background: white;
            flex-shrink: 0;
        }

        .gallery-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #7f8c8d;
        }

        .selection-info {
            color: #3498db;
            font-weight: 500;
        }

        .gallery {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            grid-auto-rows: max-content;
            gap: 12px;
            align-content: start;
        }

        .image-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            height: auto;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .image-card:hover {
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 1);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.25);
        }

        .image-card.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
        }

        .image-preview {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: #f8f9fa;
            display: block;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .image-card:hover .image-preview {
            transform: scale(1.05);
        }

        .image-info {
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s ease;
            border-radius: 0 0 8px 8px;
        }

        .image-name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
            font-size: 12px;
            word-break: break-all;
            line-height: 1.3;
            max-height: 2.4em;
            overflow: hidden;
            letter-spacing: -0.01em;
        }

        .image-meta {
            color: rgba(26, 26, 26, 0.6);
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        .image-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            gap: 6px;
            z-index: 10;
        }

        .image-card:hover .image-actions {
            opacity: 1;
            transform: translateY(-2px);
        }

        .image-card:hover .action-btn {
            animation: slideInFromRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .image-card:hover .action-btn:nth-child(1) {
            animation-delay: 0.05s;
        }

        .image-card:hover .action-btn:nth-child(2) {
            animation-delay: 0.1s;
        }

        @keyframes slideInFromRight {
            0% {
                opacity: 0;
                transform: translateX(8px) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.95);
            color: rgba(26, 26, 26, 0.7);
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.08) translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: rgba(0, 0, 0, 0.12);
        }

        .action-btn.edit {
            color: #3b82f6;
        }

        .action-btn.edit:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }

        .action-btn.delete {
            color: #ef4444;
        }

        .action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .action-btn:active {
            transform: scale(0.95) translateY(0px);
            transition: all 0.1s ease;
        }

        .action-btn svg {
            transition: all 0.2s ease;
        }

        .action-btn:hover svg {
            transform: scale(1.1);
        }

        .selected-indicator {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .image-card.selected .selected-indicator {
            display: flex;
        }

        .loading {
            text-align: center;
            padding: 60px 30px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #ecf0f1;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 骨架屏动画 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: hidden;
            height: 160px;
            display: flex;
            flex-direction: column;
        }

        .skeleton-image {
            height: 100px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .skeleton-content {
            padding: 10px;
            flex: 1;
        }

        .skeleton-title {
            height: 14px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .skeleton-meta {
            height: 10px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            width: 60%;
        }

        .empty-state {
            text-align: center;
            padding: 80px 30px;
            color: #7f8c8d;
        }

        .empty-icon {
            font-size: 64px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .footer {
            padding: 20px 30px 24px;
            background: transparent;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .footer-info {
            font-size: 14px;
            color: rgba(26, 26, 26, 0.6);
            font-weight: 500;
        }

        .footer-actions {
            display: flex;
            gap: 10px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            z-index: 2000;
            transform: translateX(400px) scale(0.9);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 4px solid #10b981;
            font-size: 14px;
            min-width: 280px;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0) scale(1);
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        .toast-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-body {
            color: rgba(26, 26, 26, 0.8);
            line-height: 1.4;
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: rgba(26, 26, 26, 0.4);
            cursor: pointer;
            font-size: 18px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: rgba(26, 26, 26, 0.8);
        }

        /* 移动端Toast适配 */
        @media (max-width: 768px) {
            .toast {
                left: 20px;
                right: 20px;
                top: auto;
                bottom: 20px;
                transform: translateY(100px) scale(0.9);
                min-width: auto;
            }
            
            .toast.show {
                transform: translateY(0) scale(1);
            }
        }

        /* 确认弹窗样式 */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 2500;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .confirm-modal.show {
            display: flex;
            opacity: 1;
        }

        .confirm-modal.show .confirm-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .confirm-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .confirm-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
        }

        .confirm-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .confirm-message {
            font-size: 16px;
            color: rgba(26, 26, 26, 0.7);
            line-height: 1.5;
            margin-bottom: 32px;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 100px;
            position: relative;
            overflow: hidden;
        }

        /* .confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .confirm-btn:hover::before {
            left: 100%;
        } */

        .confirm-btn-cancel {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.2);
        }

        .confirm-btn-cancel:hover {
            background: rgba(107, 114, 128, 0.15);
            color: #4b5563;
            transform: translateY(-1px);
        }

        .confirm-btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        .confirm-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4);
        }

        .confirm-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .confirm-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
        }

        .confirm-btn:active {
            transform: scale(0.98);
        }

        /* 移动端确认弹窗适配 */
        @media (max-width: 768px) {
            .confirm-content {
                width: 95%;
                margin: 20px;
                padding: 28px 24px;
                border-radius: 16px;
            }
            
            .confirm-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }
            
            .confirm-title {
                font-size: 20px;
            }
            
            .confirm-buttons {
                flex-direction: column;
            }
            
            .confirm-btn {
                width: 100%;
                padding: 16px 24px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 25px 25px 35px;
            max-width: 600px;
            width: 90%;
            max-height: 75vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.24),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* 重命名弹窗的特殊优化 */
        #renameModal .modal-content {
            max-height: none; /* 重命名弹窗内容较少，不需要滚动 */
            overflow: hidden; /* 保持边界约束，避免动画超出弹窗 */
            padding: 25px 25px 45px; /* 增加底部padding来容纳按钮效果 */
        }

        /* 响应式弹窗 */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                border-radius: 20px 20px 0 0;
                position: fixed;
                bottom: 0;
                top: auto;
                transform: translateY(100%);
                max-height: 80vh; /* 移动端稍微增加高度 */
                padding: 25px 25px 40px; /* 移动端增加更多底部padding */
            }
            
            .modal.show .modal-content {
                transform: translateY(0);
            }

            /* 移动端重命名弹窗优化 */
            #renameModal .modal-content {
                max-height: none;
                overflow: hidden; /* 保持边界约束 */
                padding: 25px 25px 40px; /* 足够的底部空间 */
            }

            /* 移动端按钮效果更加轻微 */
            .modal-content .btn:hover {
                transform: scale(1.005) !important; /* 非常轻微的缩放 */
            }

            .modal-content .btn-primary:hover {
                box-shadow: 0 1px 8px rgba(59, 130, 246, 0.2) !important; /* 更小的阴影 */
            }

            .modal-content .btn-secondary:hover {
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.08) !important; /* 更小的阴影 */
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e8ed;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }

        .close-btn:hover {
            background: #ecf0f1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-bottom: 8px; /* 为按钮hover效果预留适当空间 */
        }

        /* 模态框内按钮的特殊hover样式，精细化处理 */
        .modal-content .btn:hover {
            transform: scale(1.01) !important; /* 更轻微的缩放效果 */
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important; /* 更快的过渡 */
        }

        .modal-content .btn-primary:hover {
            transform: scale(1.01) !important;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.25) !important; /* 更内敛的阴影 */
            background: linear-gradient(135deg, #4f8ef7 0%, #2563eb 100%) !important; /* 轻微的颜色变化 */
        }

        .modal-content .btn-secondary:hover {
            transform: scale(1.01) !important;
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1a1a1a !important;
            border-color: rgba(0, 0, 0, 0.2) !important;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1) !important; /* 添加轻微阴影 */
        }

        /* 按钮点击效果 */
        .modal-content .btn:active {
            transform: scale(0.99) !important;
            transition: all 0.1s ease !important;
        }

        .preview-modal .modal-content {
            max-width: 800px;
            width: 95%;
            max-height: 85vh;
        }

        .preview-modal .modal-header {
            padding: 20px 25px;
            margin-bottom: 0;
        }

        .preview-image {
            width: 100%;
            max-height: 60vh;
            object-fit: contain;
            display: block;
            background: #f8f9fa;
        }

        .preview-info {
            padding: 20px;
        }

        .preview-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .preview-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .preview-detail {
            display: flex;
            justify-content: space-between;
        }

        .keyboard-hint {
            font-size: 11px;
            color: #95a5a6;
            text-align: center;
            margin-top: 5px;
        }

        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .upload-overlay.show {
            display: flex;
        }

        .upload-area {
            background: white;
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 2px dashed #3b82f6;
            transition: all 0.3s ease;
        }

        .upload-area.drag-over {
            border-color: #fa709a;
            background: linear-gradient(135deg, rgba(250, 112, 154, 0.05) 0%, rgba(254, 225, 64, 0.05) 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .upload-area h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 22px;
            font-weight: 600;
        }

        .upload-area p {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .upload-link {
            background: none;
            border: none;
            color: #3b82f6;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            font-size: 16px;
        }

        .upload-link:hover {
            color: #fa709a;
        }

        .upload-tips {
            color: #95a5a6;
            font-size: 14px;
        }

        .close-upload {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: #95a5a6;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-upload:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .upload-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 2100;
            display: none;
            min-width: 300px;
        }

        .upload-progress.show {
            display: block;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
                padding: 12px;
            }
            
            .image-card {
                min-height: 140px;
            }
            
            .image-preview {
                height: 90px;
            }
            
            .toolbar-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .toolbar-left {
                justify-content: center;
            }

            .toolbar-left.centered {
                justify-content: center;
                width: 100%;
            }

            .toolbar-center {
                justify-content: center;
            }

            .toolbar-center.hidden {
                display: none;
            }

            .footer {
                flex-direction: column;
                gap: 10px;
                padding: 16px 20px 20px;
            }

            .upload-area {
                padding: 40px 30px;
                margin: 20px;
                max-width: 95%;
            }

            .upload-area h3 {
                font-size: 20px;
            }

            .btn {
                min-width: auto;
                padding: 12px 24px;
                font-size: 13px;
            }

            .filter-btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .header {
                padding: 16px 20px 12px;
            }

            .header h1 {
                font-size: 20px;
            }

            .toolbar {
                padding: 12px 20px;
            }

            .gallery-header {
                padding: 10px 15px 6px;
            }
        }

        .video-preview {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            flex-shrink: 0;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .video-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 6px;
            opacity: 0.9;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .video-label {
            font-size: 11px;
            font-weight: 600;
            opacity: 0.95;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .image-fallback {
            width: 100%;
            height: 100px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21,15 16,10 5,21"/>
                </svg>
                媒体选择器
            </h1>
            <div class="header-info" id="headerInfo">选择图片或视频插入到编辑器或表单中</div>
        </div>

        <!-- 顶部工具栏布局优化 -->
        <div class="toolbar">
            <div class="toolbar-row">
                <div class="toolbar-left">
                    <button type="button" class="btn btn-primary btn-upload" onclick="showUploadArea()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        本地上传
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="refreshGallery()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M3 21v-5h5"/>
                        </svg>
                        刷新
                    </button>
                </div>
                <div class="toolbar-center" style="display: none;">
                    <div class="media-filter">
                        <button type="button" class="filter-btn active" data-type="image" onclick="setMediaType('image')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21,15 16,10 5,21"/>
                            </svg>
                            图片
                        </button>
                        <button type="button" class="filter-btn" data-type="video" onclick="setMediaType('video')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5,3 19,12 5,21 5,3"/>
                            </svg>
                            视频
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="gallery-container">
            <div class="gallery-header">
                <div class="gallery-stats">
                    <span id="imageCount">正在加载媒体文件...</span>
                    <span class="selection-info" id="selectionInfo">未选择</span>
                </div>
            </div>

            <div class="gallery" id="gallery">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>正在加载媒体文件...</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-info">
                <div>双击媒体预览 • Ctrl+点击多选 • ESC取消选择</div>
                <div class="keyboard-hint">快捷键：Enter确认 • Delete删除 • F2重命名</div>
            </div>
            <div class="footer-actions">
                <button type="button" class="btn btn-primary" onclick="confirmSelection()" id="confirmBtn" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                    确认选择 (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- 重命名模态框 -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">重命名图片</h3>
                <button class="close-btn" onclick="closeModal('renameModal', event)">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">新文件名</label>
                <input type="text" class="form-input" id="newFileName" placeholder="输入新的文件名">
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="closeModal('renameModal', event)">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmRename()">确认</button>
            </div>
        </div>
    </div>

    <!-- 预览模态框 -->
    <div class="modal preview-modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">图片预览</h3>
                <button class="close-btn" onclick="closeModal('previewModal', event)">&times;</button>
            </div>
            <img id="previewImage" class="preview-image" alt="预览图片">
            <div class="preview-info">
                <div class="preview-name" id="previewName"></div>
                <div class="preview-details" id="previewDetails"></div>
            </div>
        </div>
    </div>

    <!-- 拖拽上传区域 -->
    <div class="upload-overlay" id="uploadOverlay">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </div>
            <h3 id="uploadTitle">拖拽媒体文件到这里上传</h3>
            <p>或者 <button class="upload-link" onclick="document.getElementById('uploadInput').click()">点击选择文件</button></p>
            <div class="upload-tips" id="uploadTips">
                <small>支持图片：JPG、PNG、GIF、WebP、BMP、SVG，视频：MP4、AVI、MOV、WMV、FLV、MKV、WebM，单个文件最大 200MB</small>
            </div>
            <button class="close-upload" onclick="hideUploadArea()">&times;</button>
        </div>
    </div>

    <!-- 上传进度 -->
    <div class="upload-progress" id="uploadProgress">
        <div class="progress-content">
            <div class="progress-title">正在本地上传文件...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
    </div>

    <!-- 确认弹窗 -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirmIcon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="m19,6v14a2 2 0 0 1-2,2H7a2 2 0 0 1-2-2V6m3,0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2,2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </div>
            <h3 class="confirm-title" id="confirmTitle">确认删除</h3>
            <p class="confirm-message" id="confirmMessage">此操作无法撤销，确定要继续吗？</p>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-cancel" onclick="hideConfirmModal()">取消</button>
                <button class="confirm-btn confirm-btn-danger" id="confirmButton" onclick="confirmAction()">确认删除</button>
            </div>
        </div>
    </div>

    <script>
        let allMediaFiles = [];
        let selectedMediaFiles = new Set();
        let isMultiSelect = false;
        let currentRenameImage = null;
        
        // 分页加载配置
        let currentPage = 0;
        let pageSize = 20; // 每页显示20张图片
        let isLoading = false;
        
        // 确认弹窗状态
        let confirmCallback = null;
        
        // 当前媒体类型
        let currentMediaType = 'image';
        
        // 媒体文件类型检测
        function getMediaType(fileName) {
            const ext = fileName.toLowerCase().split('.').pop();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];
            const videoExts = ['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv', 'webm'];
            
            if (imageExts.includes(ext)) return 'image';
            if (videoExts.includes(ext)) return 'video';
            return 'unknown';
        }
        
        // 设置媒体类型
        function setMediaType(type) {
            currentMediaType = type;
            
            // 清除选择状态
            selectedMediaFiles.clear();
            
            // 更新按钮状态
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // 更新标题和描述
            updateUIForMediaType(type);
            
            // 立即显示加载状态
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = generateSkeletonCards();
            
            // 重新加载对应类型的媒体文件
            loadMediaFiles();
        }
        
        // 根据媒体类型更新UI
        function updateUIForMediaType(type) {
            const title = document.querySelector('.header h1');
            const headerInfo = document.getElementById('headerInfo');
            const uploadBtn = document.querySelector('.btn-upload');
            const uploadTitle = document.getElementById('uploadTitle');
            const uploadTips = document.getElementById('uploadTips');
            
            if (type === 'image') {
                title.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    图片选择器
                `;
                headerInfo.textContent = '选择图片插入到编辑器或表单中';
            } else {
                title.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5,3 19,12 5,21 5,3"/>
                    </svg>
                    视频选择器
                `;
                headerInfo.textContent = '选择视频插入到编辑器或表单中';
            }
            uploadBtn.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                本地上传
            `;
            uploadTitle.textContent = '拖拽媒体文件到这里上传';
            uploadTips.innerHTML = '<small>支持图片：JPG、PNG、GIF、WebP、BMP、SVG，视频：MP4、AVI、MOV、WMV、FLV、MKV、WebM，单个文件最大 200MB</small>';
        }

        // 统一的API错误处理函数
        async function handleApiResponse(response, operation = '操作') {
            // 读取响应文本（只能读取一次）
            const responseText = await response.text();
            
            // 检查HTTP状态
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('请先登录后台管理系统');
                }
                
                // 尝试解析错误信息
                let errorMessage = `HTTP ${response.status} ${response.statusText}`;
                try {
                    const errorData = JSON.parse(responseText);
                    errorMessage = errorData.message || errorData.msg || errorData.error || errorMessage;
                } catch (e) {
                    // 如果不是JSON，使用原始文本
                    if (responseText.trim()) {
                        errorMessage = responseText.length > 100 ? 
                            responseText.substring(0, 100) + '...' : 
                            responseText;
                    }
                }
                
                throw new Error(`${operation}失败: ${errorMessage}`);
            }
            
            // 检查响应类型
            const contentType = response.headers.get('content-type') || '';
            
            // 检查是否是HTML响应（登录页面）
            if (responseText.includes('<html') || responseText.includes('<!DOCTYPE') || responseText.includes('<title>')) {
                throw new Error('请先登录后台管理系统');
            }
            
            // 检查是否是空响应
            if (responseText.trim() === '') {
                throw new Error('服务器返回了空响应');
            }

            // 解析JSON响应
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (jsonError) {
                console.error(`${operation}JSON解析失败:`, jsonError);
                
                // 如果不是JSON格式，给出更具体的错误信息
                if (contentType.includes('text/plain')) {
                    throw new Error(`服务器返回文本响应: ${responseText}`);
                } else if (contentType.includes('text/html')) {
                    throw new Error('服务器返回了HTML页面，可能需要重新登录');
                } else {
                    throw new Error(`JSON解析错误，响应格式: ${contentType}`);
                }
            }
            
            return result;
        }

        // 统一的登录错误处理
        function handleLoginError(context = '操作') {
            showToast('请先登录后台管理系统', 'error');
            setTimeout(() => {
                showConfirmModal({
                    title: '需要登录',
                    message: `需要登录后台管理系统才能${context}，是否前往登录页面？`,
                    confirmText: '前往登录',
                    cancelText: '稍后再说',
                    icon: 'warning',
                    danger: false,
                    onConfirm: () => {
                        window.open('/admin', '_blank');
                    }
                });
            }, 1000);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查URL参数
            const urlParams = new URLSearchParams(window.location.search);
            isMultiSelect = urlParams.get('multi') === 'true';
            
            // 检查媒体类型参数
            const typeParam = urlParams.get('type');
            const toolbarCenter = document.querySelector('.toolbar-center');
            if (typeParam === 'video') {
                currentMediaType = 'video';
                // 隐藏切换按钮
                if (toolbarCenter) toolbarCenter.style.display = 'none';
                // 更新按钮状态
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('[data-type="video"]').classList.add('active');
                document.querySelector('[data-type="image"]').classList.remove('active');
            } else if (typeParam === 'image') {
                currentMediaType = 'image';
                // 隐藏切换按钮
                if (toolbarCenter) toolbarCenter.style.display = 'none';
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('[data-type="image"]').classList.add('active');
            } else {
                // 未指定type，显示切换按钮
                if (toolbarCenter) toolbarCenter.style.display = '';
                currentMediaType = 'image';
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('[data-type="image"]').classList.add('active');
            }
            
            // 更新UI
            updateUIForMediaType(currentMediaType);
            
            // 初始化拖拽上传
            initializeDragUpload();
            
            // 初始化文件选择
            initializeFileInput();
            
            // 加载媒体文件
            loadMediaFiles();
            
            // 键盘快捷键
            initializeKeyboardShortcuts();
        });

        // 初始化拖拽上传功能
        function initializeDragUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const uploadOverlay = document.getElementById('uploadOverlay');
            
            // 阻止默认拖拽行为
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            // 拖拽进入
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            // 拖拽离开
            ['dragleave'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            // 拖拽放下
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }
            
            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                unhighlight(e);
                const files = e.dataTransfer.files;
                handleFiles(files);
            }
        }

        // 初始化文件选择
        function initializeFileInput() {
            document.getElementById('uploadInput').addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });
        }

        // 初始化键盘快捷键
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // ESC - 取消选择
                    selectedMediaFiles.clear();
                    updateUI();
                } else if (e.key === 'Enter') {
                    // Enter - 确认选择
                    if (selectedMediaFiles.size > 0) {
                        confirmSelection();
                    }
                } else if (e.key === 'Delete') {
                    // Delete - 删除选中图片
                    if (selectedMediaFiles.size > 0) {
                        deleteSelectedMediaFiles();
                    }
                } else if (e.key === 'F2') {
                    // F2 - 重命名
                    if (selectedMediaFiles.size === 1) {
                        const imagePath = Array.from(selectedMediaFiles)[0];
                        const image = allMediaFiles.find(img => img.path === imagePath);
                        if (image) {
                            renameImage(image.path, image.name);
                        }
                    }
                }
            });
        }

        // 生成骨架屏
        function generateSkeletonCards(count = 8) {
            return Array(count).fill(0).map(() => `
                <div class="skeleton-card">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-meta"></div>
                    </div>
                </div>
            `).join('');
        }

        // 加载媒体文件列表
        async function loadMediaFiles() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = generateSkeletonCards();

            try {
                const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
                console.log(`开始加载${mediaTypeName}列表...`);
                
                // 根据媒体类型选择不同的API
                const apiUrl = currentMediaType === 'image' ? '/admin/upload/list' : '/admin/upload/videoList';
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'include' // 包含cookie以保持登录状态
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('请先登录后台管理系统');
                    }
                    throw new Error(`网络请求失败: ${response.status} ${response.statusText}`);
                }

                // 检查响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // 如果不是JSON响应，可能是HTML登录页面
                    const text = await response.text();
                    
                    if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                        throw new Error('请先登录后台管理系统');
                    } else {
                        throw new Error('服务器返回了非JSON格式的响应');
                    }
                }

                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    console.error('JSON解析失败:', jsonError);
                    // 尝试获取响应文本内容进行诊断
                    const text = await response.text();
                    
                    if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                        throw new Error('请先登录后台管理系统');
                    } else {
                        throw new Error('服务器响应格式错误，请检查接口返回数据');
                    }
                }
                
                if (result.status === true) {
                    allMediaFiles = result.data || [];
                    displayMediaFiles();
                } else {
                    const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
                    throw new Error(result.message || result.msg || `获取${mediaTypeName}列表失败`);
                }
            } catch (error) {
                const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
                console.error(`加载${mediaTypeName}失败:`, error);
                let errorMessage = error.message;
                let actionButton = '<button class="btn btn-primary" onclick="loadMediaFiles()">重新加载</button>';
                
                if (error.message.includes('登录')) {
                    errorMessage = `需要登录后台管理系统才能访问${mediaTypeName}库`;
                    actionButton = '<a href="/admin" target="_blank" class="btn btn-primary">前往登录</a>';
                    // 更新页面头部提示
                    document.getElementById('headerInfo').innerHTML = `⚠️ 需要登录后台管理系统才能使用${mediaTypeName}选择器`;
                    document.getElementById('headerInfo').style.color = '#e74c3c';
                } else if (error.message.includes('Unexpected token')) {
                    errorMessage = '服务器返回了意外的数据格式，可能需要先登录';
                    actionButton = '<a href="/admin" target="_blank" class="btn btn-primary">前往登录</a>';
                    // 更新页面头部提示
                    document.getElementById('headerInfo').innerHTML = '⚠️ 数据格式异常，请尝试重新登录后台管理系统';
                    document.getElementById('headerInfo').style.color = '#e74c3c';
                }
                
                gallery.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🔐</div>
                        <h3>访问受限</h3>
                        <p style="color: #e74c3c; font-weight: 500;">${errorMessage}</p>
                        <div style="margin-top: 20px;">
                            ${actionButton}
                            <button class="btn btn-secondary" onclick="loadMediaFiles()" style="margin-left: 10px;">重试</button>
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #7f8c8d;">
                            请确保已在后台管理系统中登录
                        </div>
                    </div>
                `;
            }
        }

        // 显示媒体文件
        function displayMediaFiles() {
            // 重置分页状态
            currentPage = 0;
            isLoading = false;
            
            // 更新过滤后的媒体文件列表
            displayImages(allMediaFiles);
            updateStats();
        }

        // 显示媒体文件（分批加载）
        function displayImages(images, append = false) {
            const gallery = document.getElementById('gallery');
            
            if (!images || images.length === 0) {
                if (!append) {
                    const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
                    gallery.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📁</div>
                            <h3>没有找到${mediaTypeName}</h3>
                            <p>请通过后台管理系统上传${mediaTypeName}文件</p>
                        </div>
                    `;
                }
                return;
            }

            // 分批显示，避免一次性渲染太多
            const startIndex = append ? currentPage * pageSize : 0;
            const endIndex = Math.min(startIndex + pageSize, images.length);
            const imagesToShow = images.slice(startIndex, endIndex);
            
            console.log(`显示第 ${startIndex + 1}-${endIndex} 个媒体文件，共 ${images.length} 个`);
            
            const html = imagesToShow.map((media, index) => {
                const isSelected = selectedMediaFiles.has(media.path);
                const selectionIndex = getSelectionIndex(media.path);
                const isVideo = currentMediaType === 'video';
                
                return `
                    <div class="image-card ${isSelected ? 'selected' : ''}" 
                         data-path="${media.path}" 
                         onclick="selectImage('${media.path}', event)"
                         ondblclick="previewImage('${media.path}')">
                        
                        <div class="selected-indicator">${selectionIndex}</div>
                        
                        ${isVideo ? `
                            <div class="video-preview">
                                <svg class="video-icon" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <polygon points="5,3 19,12 5,21 5,3"/>
                                </svg>
                                <div class="video-label">视频</div>
                            </div>
                        ` : `
                            <img src="${media.url || media.path}" 
                                 alt="${media.name}" 
                                 class="image-preview"
                                 loading="lazy"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="image-fallback" style="display: none; width: 100%; height: 120px; background: #f8f9fa; align-items: center; justify-content: center; color: #6c757d;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">🖼️</div>
                                    <div style="font-size: 12px;">图片加载失败</div>
                                </div>
                            </div>
                        `}
                        
                        <div class="image-info">
                            <div class="image-name" title="${media.name}">${media.name}</div>
                            <div class="image-meta">
                                <span class="file-size">${formatFileSize(media.size)}</span>
                                <span class="file-date">${formatDate(media.modified)}</span>
                            </div>
                            <div class="image-actions">
                                <button class="action-btn preview-btn" onclick="event.stopPropagation(); previewImage('${media.path}')" title="预览">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                <button class="action-btn rename-btn" onclick="event.stopPropagation(); renameImage('${media.path}', '${media.name}')" title="重命名">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteImage('${media.path}')" title="删除">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (append) {
                // 移除加载更多按钮
                const loadMoreBtn = gallery.querySelector('.load-more-btn');
                if (loadMoreBtn) loadMoreBtn.remove();
                
                gallery.insertAdjacentHTML('beforeend', html);
            } else {
                gallery.innerHTML = html;
                currentPage = 0;
            }
            
            // 如果还有更多图片，添加加载更多按钮
            if (endIndex < images.length) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-btn';
                loadMoreBtn.style.cssText = `
                    grid-column: 1/-1;
                    text-align: center;
                    padding: 20px;
                `;
                loadMoreBtn.innerHTML = `
                    <button class="btn btn-primary" onclick="loadMoreImages()">
                        加载更多 (${endIndex}/${images.length})
                    </button>
                `;
                gallery.appendChild(loadMoreBtn);
            }
            
            // 延迟更新UI，让图片有时间渲染
            setTimeout(() => {
                updateUI();
            }, 50);
        }
        
        // 加载更多媒体文件
        function loadMoreImages() {
            if (isLoading) return;
            
            isLoading = true;
            currentPage++;
            
            setTimeout(() => {
                displayImages(allMediaFiles, true);
                isLoading = false;
            }, 100);
        }

        // 获取选择序号
        function getSelectionIndex(path) {
            if (!selectedMediaFiles.has(path)) return '';
            const selectedArray = Array.from(selectedMediaFiles);
            return selectedArray.indexOf(path) + 1;
        }

        // 选择媒体文件
        function selectImage(path, event) {
            if (event.ctrlKey || event.metaKey || isMultiSelect) {
                // 多选模式
                if (selectedMediaFiles.has(path)) {
                    selectedMediaFiles.delete(path);
                } else {
                    selectedMediaFiles.add(path);
                }
            } else {
                // 单选模式
                selectedMediaFiles.clear();
                selectedMediaFiles.add(path);
            }

            updateUI();
        }

        // 预览媒体文件
        function previewImage(path) {
            const media = allMediaFiles.find(item => item.path === path);
            if (!media) {
                console.error('找不到媒体文件:', path);
                return;
            }
            
            console.log('预览媒体文件:', media);
            
            const previewImg = document.getElementById('previewImage');
            const previewName = document.getElementById('previewName');
            const details = document.getElementById('previewDetails');
            const modalTitle = document.querySelector('#previewModal .modal-title');
            
            // 显示模态框
            showModal('previewModal');
            
            // 清空之前的内容
            previewImg.style.display = 'none';
            previewImg.src = '';
            previewName.textContent = media.name;
            
            // 显示加载状态
            details.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                    <div>正在加载${currentMediaType === 'image' ? '图片' : '视频'}...</div>
                </div>
            `;
            
            // 根据媒体类型显示不同的预览
            const mediaUrl = media.url || media.path;
            console.log('媒体文件URL:', mediaUrl);
            
            if (currentMediaType === 'image') {
                modalTitle.textContent = '图片预览';
                // 图片预览
                previewImg.style.display = 'block';
                previewImg.onload = function() {
                    console.log('图片加载成功');
                    details.innerHTML = `
                        <div class="preview-detail">
                            <span>文件大小:</span>
                            <span>${formatFileSize(media.size)}</span>
                        </div>
                        <div class="preview-detail">
                            <span>修改时间:</span>
                            <span>${formatDate(media.modified)}</span>
                        </div>
                        <div class="preview-detail" style="grid-column: 1 / -1; justify-content: flex-start; gap: 8px;">
                            <span>文件路径:</span>
                            <span style="font-family: monospace; font-size: 12px; word-break: break-all;">${media.path}</span>
                        </div>
                    `;
                };
                
                previewImg.onerror = function() {
                    console.error('图片加载失败:', mediaUrl);
                    this.style.display = 'none';
                    details.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e74c3c;">
                            <div style="font-size: 48px; margin-bottom: 15px;">❌</div>
                            <div>图片加载失败</div>
                            <div style="font-size: 12px; margin-top: 10px; color: #7f8c8d; word-break: break-all;">${mediaUrl}</div>
                            <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="preview-detail">
                                    <span>文件大小:</span>
                                    <span>${formatFileSize(media.size)}</span>
                                </div>
                                <div class="preview-detail">
                                    <span>修改时间:</span>
                                    <span>${formatDate(media.modified)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                };
                
                // 设置图片源
                previewImg.src = mediaUrl;
            } else {
                modalTitle.textContent = '视频预览';
                // 视频预览，将其注入到图片元素的位置，而不是详情区域
                previewImg.style.display = 'none'; // 隐藏图片元素
                const videoContainer = document.createElement('div');
                videoContainer.innerHTML = `
                    <video controls style="width: 100%; max-height: 60vh; border-radius: 8px; background: #000;">
                        <source src="${mediaUrl}" type="video/mp4">
                        您的浏览器不支持视频播放
                    </video>
                `;
                // 确保只添加一次视频
                const existingVideo = previewImg.parentElement.querySelector('video');
                if (existingVideo) {
                    existingVideo.parentElement.remove();
                }
                previewImg.parentElement.insertBefore(videoContainer, previewImg.nextSibling);
                
                details.innerHTML = `
                    <div class="preview-detail">
                        <span>文件大小:</span>
                        <span>${formatFileSize(media.size)}</span>
                    </div>
                    <div class="preview-detail">
                        <span>修改时间:</span>
                        <span>${formatDate(media.modified)}</span>
                    </div>
                    <div class="preview-detail" style="grid-column: 1 / -1; justify-content: flex-start; gap: 8px;">
                        <span>文件路径:</span>
                        <span style="font-family: monospace; font-size: 12px; word-break: break-all;">${media.path}</span>
                    </div>
                `;
            }
        }

        // 更新UI状态
        function updateUI() {
            // 更新卡片选中状态
            document.querySelectorAll('.image-card').forEach(card => {
                const path = card.dataset.path;
                if (selectedMediaFiles.has(path)) {
                    card.classList.add('selected');
                    card.querySelector('.selected-indicator').textContent = getSelectionIndex(path);
                } else {
                    card.classList.remove('selected');
                }
            });

            // 更新选择信息
            updateSelectionInfo();
            
            // 更新确认按钮
            const confirmBtn = document.getElementById('confirmBtn');
            const selectedCount = document.getElementById('selectedCount');
            
            selectedCount.textContent = selectedMediaFiles.size;
            confirmBtn.disabled = selectedMediaFiles.size === 0;
        }

        // 更新统计信息
        function updateStats() {
            const imageCount = document.getElementById('imageCount');
            const total = allMediaFiles.length;
            const filtered = allMediaFiles.length;
            const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
            
            if (total === filtered) {
                imageCount.textContent = `共 ${total} 个${mediaTypeName}`;
            } else {
                imageCount.textContent = `显示 ${filtered} / ${total} 个${mediaTypeName}`;
            }
        }

        // 更新选择信息
        function updateSelectionInfo() {
            const selectionInfo = document.getElementById('selectionInfo');
            const count = selectedMediaFiles.size;
            const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
            
            if (count === 0) {
                selectionInfo.textContent = '未选择';
            } else if (count === 1) {
                selectionInfo.textContent = `已选择 1 个${mediaTypeName}`;
            } else {
                selectionInfo.textContent = `已选择 ${count} 个${mediaTypeName}`;
            }
        }

        // 确认选择
        function confirmSelection() {
            if (selectedMediaFiles.size === 0) {
                const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
                showToast(`请先选择${mediaTypeName}`, 'error');
                return;
            }

            const selectedPaths = Array.from(selectedMediaFiles);
            
            if (window.opener) {
                // 弹窗模式 - 发送消息给父窗口
                window.opener.postMessage({
                    type: 'mediaSelected',
                    mediaType: currentMediaType,
                    files: selectedPaths,
                    multi: isMultiSelect
                }, '*');
                window.close();
            } else if (parent !== window) {
                // iframe模式 - 发送消息给父框架
                parent.postMessage({
                    type: 'mediaSelected',
                    mediaType: currentMediaType,
                    files: selectedPaths,
                    multi: isMultiSelect
                }, '*');
            } else {
                // 直接访问 - 复制到剪贴板
                const mediaUrls = selectedPaths.join('\n');
                navigator.clipboard.writeText(mediaUrls).then(() => {
                    const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
                    showToast(`${mediaTypeName}路径已复制到剪贴板`, 'success');
                }).catch(() => {
                    // 如果复制失败，显示在弹窗中
                    const mediaTypeName = currentMediaType === 'image' ? '图片' : '视频';
                    alert(`选中的${mediaTypeName}路径：\n\n` + mediaUrls);
                });
            }
        }

        // 删除选中的图片
        async function deleteSelectedMediaFiles() {
            if (selectedMediaFiles.size === 0) return;
            
            const count = selectedMediaFiles.size;
            
            showConfirmModal({
                title: `批量删除${currentMediaType === 'image' ? '图片' : '视频'}`,
                message: `确定要删除选中的 ${count} 个${currentMediaType === 'image' ? '图片' : '视频'}吗？此操作无法撤销，请谨慎操作。`,
                confirmText: `删除 ${count} 个${currentMediaType === 'image' ? '图片' : '视频'}`,
                icon: 'delete',
                danger: true,
                onConfirm: async () => {
                    const paths = Array.from(selectedMediaFiles);
                    let successCount = 0;
                    
                    // 显示删除进度Toast
                    showToast(`开始批量删除${currentMediaType === 'image' ? '图片' : '视频'}...`, 'info', 2000);
                    
                    // 验证删除路径的安全性
                    const expectedPrefix = currentMediaType === 'image' ? '/uploads/images/' : '/uploads/video/';
                    const validPaths = paths.filter(path => path.startsWith(expectedPrefix));
                    
                    if (validPaths.length !== paths.length) {
                        showToast(`部分文件路径无效，已跳过`, 'warning');
                    }
                    
                    for (const path of validPaths) {
                        try {
                            await deleteImageByPath(path);
                            successCount++;
                        } catch (error) {
                            console.error('删除失败:', path, error);
                        }
                    }
                    
                    if (successCount > 0) {
                        showToast(`成功删除 ${successCount} 个${currentMediaType === 'image' ? '图片' : '视频'}${successCount < count ? `，失败 ${count - successCount} 个` : ''}`, 'success');
                        selectedMediaFiles.clear();
                        loadMediaFiles();
                    } else {
                        showToast(`删除失败，请重试`, 'error');
                    }
                }
            });
        }

        // 删除单张图片
        async function deleteImage(path) {
            // 获取图片信息用于显示
            const media = allMediaFiles.find(img => img.path === path);
            const mediaName = media ? media.name : `该${currentMediaType === 'image' ? '图片' : '视频'}`;
            
            // 验证删除路径的安全性
            const expectedPrefix = currentMediaType === 'image' ? '/uploads/images/' : '/uploads/video/';
            if (!path.startsWith(expectedPrefix)) {
                showToast(`不允许删除非${currentMediaType === 'image' ? '图片' : '视频'}目录的文件`, 'error');
                return;
            }
            
            showConfirmModal({
                title: `删除${currentMediaType === 'image' ? '图片' : '视频'}`,
                message: `确定要删除${currentMediaType === 'image' ? '图片' : '视频'} "${mediaName}" 吗？此操作无法撤销。`,
                confirmText: `删除${currentMediaType === 'image' ? '图片' : '视频'}`,
                icon: 'delete',
                danger: true,
                onConfirm: async () => {
                    try {
                        await deleteImageByPath(path);
                        showToast(`成功删除${currentMediaType === 'image' ? '图片' : '视频'} "${mediaName}"`, 'success');
                        selectedMediaFiles.delete(path);
                        loadMediaFiles();
                    } catch (error) {
                        showToast('删除失败: ' + error.message, 'error');
                    }
                }
            });
        }

        // 删除图片API调用
        async function deleteImageByPath(path) {
            const response = await fetch('/admin/upload/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: path }),
                credentials: 'include'
            });

            const result = await handleApiResponse(response, '删除图片');
            
            if (!result.status && result.code !== 200) {
                throw new Error(result.message || result.msg || '删除失败');
            }
        }

        // 重命名图片
        function renameImage(path, currentName, triggerElement = null) {
            currentRenameImage = { path, currentName };
            document.getElementById('newFileName').value = currentName;
            showModal('renameModal', triggerElement);
        }

        async function confirmRename() {
            const newName = document.getElementById('newFileName').value.trim();
            if (!newName || !currentRenameImage) return;

            // 验证文件名
            if (newName === currentRenameImage.currentName) {
                showToast('新文件名与原文件名相同', 'warning');
                return;
            }

            // 简单的文件名验证
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(newName)) {
                showToast('文件名包含非法字符', 'error');
                return;
            }

            try {
                console.log('开始重命名:', currentRenameImage.path, '->', newName);
                
                const response = await fetch('/admin/upload/rename', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldPath: currentRenameImage.path,
                        newName: newName
                    }),
                    credentials: 'include'
                });

                console.log('重命名响应状态:', response.status, response.statusText);
                console.log('响应头:', Object.fromEntries(response.headers.entries()));

                const result = await handleApiResponse(response, '重命名图片');
                
                // 检查API返回状态
                if (result.status === true || result.code === 200 || result.success === true) {
                    showToast(`文件重命名为 "${newName}" 成功`, 'success');
                    closeModal('renameModal');
                    loadMediaFiles();
                } else {
                    const errorMsg = result.message || result.msg || result.error || '重命名失败，原因未知';
                    throw new Error(errorMsg);
                }
                
            } catch (error) {
                console.error('重命名失败详细信息:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showToast('网络连接失败，请检查网络状态', 'error');
                } else if (error.message.includes('登录')) {
                    handleLoginError('重命名图片');
                } else {
                    showToast(error.message, 'error');
                }
            }
        }

        // 显示上传区域
        function showUploadArea() {
            document.getElementById('uploadOverlay').classList.add('show');
        }

        // 隐藏上传区域
        function hideUploadArea() {
            document.getElementById('uploadOverlay').classList.remove('show');
        }

        // 处理文件上传
        async function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            hideUploadArea();
            showUploadProgress();
            
            const totalFiles = files.length;
            let uploadedFiles = 0;
            let successCount = 0;
            let imageCount = 0;
            let videoCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // 更新进度
                const progress = Math.round((i / totalFiles) * 100);
                updateUploadProgress(progress, `正在上传 ${file.name}...`);
                
                try {
                    await uploadSingleFile(file);
                    successCount++;
                    
                    // 统计成功上传的文件类型
                    const fileType = getMediaType(file.name);
                    if (fileType === 'image') {
                        imageCount++;
                    } else if (fileType === 'video') {
                        videoCount++;
                    }
                } catch (error) {
                    console.error('上传失败:', file.name, error);
                    // 如果是登录相关错误，停止后续上传
                    if (error.message.includes('登录')) {
                        hideUploadProgress();
                        handleLoginError('上传文件');
                        return; // 停止上传循环
                    }
                }
                
                uploadedFiles++;
            }
            
            // 完成上传
            updateUploadProgress(100, `上传完成！成功 ${successCount}/${totalFiles} 个文件`);
            
            setTimeout(() => {
                hideUploadProgress();
                if (successCount > 0) {
                    // 根据实际上传的文件类型显示提示信息
                    let successMessage = `成功上传 ${successCount} 个文件`;
                    if (imageCount > 0 && videoCount > 0) {
                        successMessage = `成功上传 ${imageCount} 个图片和 ${videoCount} 个视频`;
                    } else if (imageCount > 0) {
                        successMessage = `成功上传 ${imageCount} 个图片`;
                    } else if (videoCount > 0) {
                        successMessage = `成功上传 ${videoCount} 个视频`;
                    }
                    showToast(successMessage, 'success');
                    loadMediaFiles(); // 重新加载媒体文件列表
                }
                if (successCount < totalFiles) {
                    showToast(`${totalFiles - successCount} 个文件上传失败`, 'error');
                }
            }, 1500);
        }

        // 上传单个文件
        async function uploadSingleFile(file) {
            const formData = new FormData();
            
            // 根据文件的实际类型选择上传接口，而不是当前选择的媒体类型
            const fileType = getMediaType(file.name);
            let uploadUrl, fieldName;
            
            if (fileType === 'video') {
                uploadUrl = '/admin/upload/video';
                fieldName = 'video';
            } else if (fileType === 'image') {
                uploadUrl = '/admin/upload/image';
                fieldName = 'image';
            } else {
                throw new Error(`不支持的文件类型: ${file.name}`);
            }
            
            formData.append(fieldName, file);
            
            const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            const result = await handleApiResponse(response, `上传${fileType === 'image' ? '图片' : '视频'}`);
            
            if (!result.status && result.code !== 200) {
                throw new Error(result.message || result.msg || '上传失败');
            }
            
            return result;
        }

        // 显示上传进度
        function showUploadProgress() {
            document.getElementById('uploadProgress').classList.add('show');
        }

        // 隐藏上传进度
        function hideUploadProgress() {
            document.getElementById('uploadProgress').classList.remove('show');
        }

        // 更新上传进度
        function updateUploadProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
            if (text) {
                document.getElementById('uploadProgress').querySelector('.progress-title').textContent = text;
            }
        }

        // 刷新图片库
        function refreshGallery() {
            selectedMediaFiles.clear();
            loadMediaFiles();
        }

        // 显示模态框
        function showModal(modalId, triggerElement = null) {
            const modal = document.getElementById(modalId);
            
            // 显示模态框
            modal.classList.add('show');
            
            // 添加焦点管理
            const firstFocusable = modal.querySelector('input, button, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) {
                setTimeout(() => firstFocusable.focus(), 100);
            }
            
            // ESC键关闭
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal(modalId);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // 点击背景关闭
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModal(modalId);
                }
            };
        }

        // 关闭模态框
        function closeModal(modalId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            document.getElementById(modalId).classList.remove('show');
        }

        // 显示确认弹窗
        function showConfirmModal(options = {}) {
            const {
                title = '确认操作',
                message = '确定要执行此操作吗？',
                confirmText = '确认',
                cancelText = '取消',
                icon = 'delete',
                onConfirm = null,
                danger = true
            } = options;
            
            // 设置内容
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const confirmBtn = document.getElementById('confirmButton');
            confirmBtn.textContent = confirmText;
            
            // 设置图标
            const iconElement = document.getElementById('confirmIcon');
            const confirmContent = document.querySelector('.confirm-content');
            
            if (icon === 'delete') {
                iconElement.innerHTML = `
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"/>
                        <path d="m19,6v14a2 2 0 0 1-2,2H7a2 2 0 0 1-2-2V6m3,0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2,2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                `;
                iconElement.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else if (icon === 'warning') {
                iconElement.innerHTML = `
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m21.73,18-8-14a2,2 0 0,0-3.48,0l-8,14A2,2 0 0,0,4,21H20a2,2 0 0,0,1.73-3Z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                `;
                iconElement.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            }
            
            // 设置按钮样式
            if (danger) {
                confirmBtn.className = 'confirm-btn confirm-btn-danger';
            } else {
                confirmBtn.className = 'confirm-btn confirm-btn-primary';
            }
            
            // 保存回调函数
            confirmCallback = onConfirm;
            
            // 显示模态框
            const modal = document.getElementById('confirmModal');
            modal.classList.add('show');
            
            // ESC键关闭
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    hideConfirmModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // 点击背景关闭
            modal.onclick = (e) => {
                if (e.target === modal) {
                    hideConfirmModal();
                }
            };
        }

        // 隐藏确认弹窗
        function hideConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
            confirmCallback = null;
            modal.onclick = null;
        }

        // 执行确认操作
        function confirmAction() {
            if (confirmCallback && typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmModal();
        }

        // 显示提示消息
        function showToast(message, type = 'success', duration = 4000) {
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const titles = {
                success: '操作成功',
                error: '操作失败',
                warning: '注意',
                info: '提示'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-header">
                    <span>${icons[type] || '📝'}</span>
                    <span>${titles[type] || '通知'}</span>
                </div>
                <div class="toast-body">${message}</div>
                <button class="toast-close" onclick="this.parentElement.classList.remove('show')">&times;</button>
            `;
            
            document.body.appendChild(toast);
            
            // 触发显示动画
            setTimeout(() => toast.classList.add('show'), 50);
            
            // 自动关闭
            const autoClose = setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 400);
            }, duration);
            
            // 点击关闭按钮时清除自动关闭定时器
            toast.querySelector('.toast-close').addEventListener('click', () => {
                clearTimeout(autoClose);
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 400);
            });
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 24 * 60 * 60 * 1000) {
                return '今天';
            } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                const days = Math.floor(diff / (24 * 60 * 60 * 1000));
                return `${days}天前`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
    </script>

    <!-- 隐藏的文件输入元素 -->
    <input type="file" id="uploadInput" style="display: none;" multiple accept="image/*,video/*">
</body>
</html>